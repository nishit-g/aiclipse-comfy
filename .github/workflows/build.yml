name: Build and Push Images
on:
  push:
    branches: [main]
    tags: ['v*']

jobs:
  build-base-common:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    - name: Login to GHCR
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    - name: Build base-common
      run: |
        export REGISTRY=ghcr.io/${{ github.repository_owner }}
        export VERSION=${{ github.ref_name }}
        docker buildx bake base-common \
          --set base-common.cache-from=type=gha,scope=base-common \
          --set base-common.cache-to=type=gha,mode=max,scope=base-common \
          --push

  build-base-gpus:
    runs-on: ubuntu-latest
    needs: build-base-common
    strategy:
      matrix:
        gpu: [rtx4090, rtx5090]
    steps:
    - uses: actions/checkout@v4
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    - name: Login to GHCR
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    - name: Build base-${{ matrix.gpu }}
      run: |
        export REGISTRY=ghcr.io/${{ github.repository_owner }}
        export VERSION=${{ github.ref_name }}
        docker buildx bake base-${{ matrix.gpu }} \
          --set base-${{ matrix.gpu }}.cache-from=type=gha,scope=base-${{ matrix.gpu }} \
          --set base-${{ matrix.gpu }}.cache-to=type=gha,mode=max,scope=base-${{ matrix.gpu }} \
          --push

  build-templates:
    runs-on: ubuntu-latest
    needs: build-base-gpus
    strategy:
      matrix:
        template: [sd15-basic]
        gpu: [4090, 5090]
    steps:
    - uses: actions/checkout@v4
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    - name: Login to GHCR
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    - name: Build ${{ matrix.template }}-${{ matrix.gpu }}
      run: |
        export REGISTRY=ghcr.io/${{ github.repository_owner }}
        export VERSION=${{ github.ref_name }}
        docker buildx bake ${{ matrix.template }}-${{ matrix.gpu }} \
          --set ${{ matrix.template }}-${{ matrix.gpu }}.cache-from=type=gha,scope=${{ matrix.template }}-${{ matrix.gpu }} \
          --set ${{ matrix.template }}-${{ matrix.gpu }}.cache-to=type=gha,mode=max,scope=${{ matrix.template }}-${{ matrix.gpu }} \
          --push
