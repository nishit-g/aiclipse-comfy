# File: .github/workflows/build.yml
# Enhanced workflow with manual template selection and smart base rebuilding

name: Build ComfyUI Deploy Images
on:
  push:
    branches: [main]
    tags: ['v*']
  workflow_dispatch:
    inputs:
      build_bases:
        description: 'Build base images (common, rtx4090, rtx5090)?'
        required: false
        default: false
        type: boolean
      build_templates:
        description: 'Select templates to build'
        required: false
        default: 'none'
        type: choice
        options:
        - 'none'
        - 'story-processing'
        - 'sd15-basic'
        - 'all-templates'
      gpu_target:
        description: 'GPU target for templates'
        required: false
        default: 'rtx4090'
        type: choice
        options:
        - 'rtx4090'
        - 'rtx5090'
        - 'both'
      force_rebuild:
        description: 'Force rebuild even if base exists?'
        required: false
        default: false
        type: boolean

env:
  REGISTRY: ghcr.io

jobs:
  # âœ… Job 1: Build base images (only when needed or requested)
  build-base-images:
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'push' ||
      (github.event_name == 'workflow_dispatch' && inputs.build_bases == true) ||
      (github.event_name == 'workflow_dispatch' && inputs.force_rebuild == true)
    permissions:
      contents: read
      packages: write
    outputs:
      base-common-exists: ${{ steps.check-base.outputs.base-common-exists }}
      base-rtx4090-exists: ${{ steps.check-base.outputs.base-rtx4090-exists }}
      base-rtx5090-exists: ${{ steps.check-base.outputs.base-rtx5090-exists }}
    strategy:
      fail-fast: false
      matrix:
        base: [common, rtx4090, rtx5090]
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    # âœ… CRITICAL: Free up disk space for base builds
    - name: Free Disk Space (Ubuntu)
      uses: jlumbroso/free-disk-space@main
      with:
        tool-cache: false
        android: true
        dotnet: true
        haskell: true
        large-packages: true
        docker-images: true
        swap-storage: true

    - name: Check available disk space
      run: |
        echo "=== Disk Space After Cleanup ==="
        df -h
        echo "Available: $(df -BG / | awk 'NR==2{print $4}')GB"

    # âœ… Check if base images already exist (skip if not forced)
    - name: Check if base image exists
      id: check-base
      run: |
        IMAGE_EXISTS=$(docker manifest inspect ${{ env.REGISTRY }}/${{ github.repository_owner }}/aiclipse-base-${{ matrix.base }}:latest >/dev/null 2>&1 && echo "true" || echo "false")
        echo "base-${{ matrix.base }}-exists=$IMAGE_EXISTS" >> $GITHUB_OUTPUT

        if [ "$IMAGE_EXISTS" = "true" ] && [ "${{ inputs.force_rebuild }}" != "true" ]; then
          echo "âœ… Base ${{ matrix.base }} already exists, skipping build"
          echo "SKIP_BUILD=true" >> $GITHUB_ENV
        else
          echo "ðŸ”¨ Will build base ${{ matrix.base }}"
          echo "SKIP_BUILD=false" >> $GITHUB_ENV
        fi

    - name: Set up Docker Buildx
      if: env.SKIP_BUILD == 'false'
      uses: docker/setup-buildx-action@v3
      with:
        buildkitd-flags: --oci-worker-gc-keepstorage 4000mb

    - name: Login to GHCR
      if: env.SKIP_BUILD == 'false'
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Build base-${{ matrix.base }}
      if: env.SKIP_BUILD == 'false'
      run: |
        export REGISTRY=${{ env.REGISTRY }}/${{ github.repository_owner }}
        export VERSION=${{ github.ref_name || 'latest' }}

        echo "ðŸ”¨ Building base-${{ matrix.base }}..."
        docker buildx bake base-${{ matrix.base }} \
          --set base-${{ matrix.base }}.cache-from=type=gha,scope=base-${{ matrix.base }} \
          --set base-${{ matrix.base }}.cache-to=type=gha,mode=max,scope=base-${{ matrix.base }} \
          --push

        echo "âœ… base-${{ matrix.base }} build completed"
        df -h

  # âœ… Job 2: Build selected templates
  build-templates:
    runs-on: ubuntu-latest
    needs: [build-base-images]
    if: |
      always() &&
      (github.event_name == 'push' ||
       (github.event_name == 'workflow_dispatch' &&
        inputs.build_templates != 'none'))
    permissions:
      contents: read
      packages: write
    strategy:
      fail-fast: false
      matrix:
        include:
          # Story Processing Template
          - template: story-processing
            gpu: rtx4090
            enabled: ${{ github.event_name == 'push' || inputs.build_templates == 'story-processing' || inputs.build_templates == 'all-templates' }}
            gpu_enabled: ${{ inputs.gpu_target == 'rtx4090' || inputs.gpu_target == 'both' || github.event_name == 'push' }}
          - template: story-processing
            gpu: rtx5090
            enabled: ${{ github.event_name == 'push' || inputs.build_templates == 'story-processing' || inputs.build_templates == 'all-templates' }}
            gpu_enabled: ${{ inputs.gpu_target == 'rtx5090' || inputs.gpu_target == 'both' || github.event_name == 'push' }}

          # SD15 Basic Template
          - template: sd15-basic
            gpu: rtx4090
            enabled: ${{ github.event_name == 'push' || inputs.build_templates == 'sd15-basic' || inputs.build_templates == 'all-templates' }}
            gpu_enabled: ${{ inputs.gpu_target == 'rtx4090' || inputs.gpu_target == 'both' || github.event_name == 'push' }}
          - template: sd15-basic
            gpu: rtx5090
            enabled: ${{ github.event_name == 'push' || inputs.build_templates == 'sd15-basic' || inputs.build_templates == 'all-templates' }}
            gpu_enabled: ${{ inputs.gpu_target == 'rtx5090' || inputs.gpu_target == 'both' || github.event_name == 'push' }}

    steps:
    - name: Check if build should run
      id: should-build
      run: |
        SHOULD_BUILD=${{ matrix.enabled == 'true' && matrix.gpu_enabled == 'true' }}
        echo "should-build=$SHOULD_BUILD" >> $GITHUB_OUTPUT

        if [ "$SHOULD_BUILD" = "true" ]; then
          echo "âœ… Will build ${{ matrix.template }}-${{ matrix.gpu }}"
        else
          echo "â­ï¸ Skipping ${{ matrix.template }}-${{ matrix.gpu }} (not selected)"
        fi

    - name: Checkout
      if: steps.should-build.outputs.should-build == 'true'
      uses: actions/checkout@v4

    - name: Free Disk Space (Ubuntu)
      if: steps.should-build.outputs.should-build == 'true'
      uses: jlumbroso/free-disk-space@main
      with:
        tool-cache: false
        android: true
        dotnet: true
        haskell: true
        large-packages: true
        docker-images: true
        swap-storage: true

    - name: Set up Docker Buildx
      if: steps.should-build.outputs.should-build == 'true'
      uses: docker/setup-buildx-action@v3
      with:
        buildkitd-flags: --oci-worker-gc-keepstorage 3000mb

    - name: Login to GHCR
      if: steps.should-build.outputs.should-build == 'true'
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Extract metadata
      if: steps.should-build.outputs.should-build == 'true'
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ github.repository_owner }}/aiclipse-${{ matrix.template }}
        tags: |
          type=raw,value=${{ matrix.gpu }}-latest,enable={{is_default_branch}}
          type=raw,value=${{ matrix.gpu }}-${{ github.ref_name }},enable=${{ github.ref_type == 'tag' }}
          type=raw,value=${{ matrix.gpu }}-{{sha}},enable=${{ github.event_name == 'push' }}

    - name: Build ${{ matrix.template }}-${{ matrix.gpu }}
      if: steps.should-build.outputs.should-build == 'true'
      uses: docker/build-push-action@v5
      with:
        context: templates/${{ matrix.template }}
        push: true
        platforms: linux/amd64
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha,scope=${{ matrix.template }}-${{ matrix.gpu }}
        cache-to: type=gha,mode=max,scope=${{ matrix.template }}-${{ matrix.gpu }}
        build-args: |
          BASE_IMAGE=${{ env.REGISTRY }}/${{ github.repository_owner }}/aiclipse-base-${{ matrix.gpu }}:latest
          TEMPLATE_TYPE=${{ matrix.template }}
          DOWNLOAD_MODELS=true

    - name: Build summary
      if: steps.should-build.outputs.should-build == 'true'
      run: |
        echo "âœ… Successfully built: ${{ matrix.template }}-${{ matrix.gpu }}"
        echo "ðŸ“¦ Image: ${{ env.REGISTRY }}/${{ github.repository_owner }}/aiclipse-${{ matrix.template }}:${{ matrix.gpu }}-latest"
        echo "ðŸ’¾ Final disk usage:"
        df -h

  # âœ… Job 3: Build summary and cleanup
  build-summary:
    runs-on: ubuntu-latest
    needs: [build-base-images, build-templates]
    if: always()
    steps:
    - name: Build Summary
      run: |
        echo "## ðŸš€ Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "### Manual Build Triggered" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Bases**: ${{ inputs.build_bases }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Templates**: ${{ inputs.build_templates }}" >> $GITHUB_STEP_SUMMARY
          echo "- **GPU Target**: ${{ inputs.gpu_target }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Force Rebuild**: ${{ inputs.force_rebuild }}" >> $GITHUB_STEP_SUMMARY
        else
          echo "### Automatic Build (Push to main)" >> $GITHUB_STEP_SUMMARY
        fi

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Available Images" >> $GITHUB_STEP_SUMMARY
        echo "Check your packages at: https://github.com/${{ github.repository_owner }}?tab=packages" >> $GITHUB_STEP_SUMMARY
