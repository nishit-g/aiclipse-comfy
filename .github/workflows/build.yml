name: Build ComfyUI Templates

on:
  push:
    branches: [main]
    paths:
      - 'base/**'
      - 'templates/**'
      - 'docker-bake.hcl'
  workflow_dispatch:
    inputs:
      target:
        description: 'What to build'
        required: true
        type: choice
        options:
        - 'base-common-only'
        - 'base-rtx4090-stack'      # builds common + rtx4090
        - 'base-rtx5090-stack'      # builds common + rtx5090
        - 'sd15-basic-4090'         # builds full stack + template
        - 'sd15-basic-5090'         # builds full stack + template
        - 'all-templates'           # builds everything
      force_rebuild:
        description: 'Force rebuild (ignore existing images)'
        required: false
        type: boolean
        default: false

env:
  REGISTRY: ghcr.io/${{ github.repository_owner }}
  VERSION: ${{ github.ref_name || 'latest' }}

jobs:
  # Step 1: Always build base-common first (root dependency)
  build-base-common:
    runs-on: ubuntu-latest
    if: ${{ !cancelled() }}
    permissions:
      contents: read
      packages: write
    outputs:
      should-skip: ${{ steps.check.outputs.should-skip }}
      image-exists: ${{ steps.check.outputs.exists }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check if base-common exists
        id: check
        run: |
          if [ "${{ inputs.force_rebuild }}" = "true" ]; then
            echo "should-skip=false" >> $GITHUB_OUTPUT
            echo "ðŸ”„ Force rebuild requested"
          elif docker manifest inspect ${{ env.REGISTRY }}/aiclipse-base-common:${{ env.VERSION }} >/dev/null 2>&1; then
            echo "should-skip=true" >> $GITHUB_OUTPUT
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "âœ… base-common:${{ env.VERSION }} exists, skipping"
          else
            echo "should-skip=false" >> $GITHUB_OUTPUT
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "ðŸ”¨ base-common:${{ env.VERSION }} missing, will build"
          fi

      - name: Free disk space
        if: steps.check.outputs.should-skip == 'false'
        run: |
          sudo rm -rf /usr/share/dotnet /opt/ghc /usr/local/share/boost
          sudo apt-get remove -y '^dotnet-.*' '^llvm-.*' azure-cli google-cloud-sdk hhvm google-chrome-stable
          sudo apt-get autoremove -y && sudo apt-get clean
          df -h

      - name: Set up Docker Buildx
        if: steps.check.outputs.should-skip == 'false'
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            image=moby/buildkit:buildx-stable-1
            restart-policy=no

      - name: Login to GHCR
        if: steps.check.outputs.should-skip == 'false'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push base-common
        if: steps.check.outputs.should-skip == 'false'
        run: |
          docker buildx bake base-common \
            --set base-common.cache-from=type=gha,scope=base-common \
            --set base-common.cache-to=type=gha,mode=max,scope=base-common \
            --push

  # Step 2: Build GPU bases (depend on base-common)
  build-gpu-bases:
    runs-on: ubuntu-latest
    needs: build-base-common
    if: ${{ !cancelled() && !failure() }}
    permissions:
      contents: read
      packages: write
    strategy:
      fail-fast: false
      matrix:
        gpu: [rtx4090, rtx5090]
    steps:
      - name: Should build this GPU base?
        id: should-build
        run: |
          TARGET="${{ inputs.target || 'all-templates' }}"
          GPU="${{ matrix.gpu }}"

          case "$TARGET" in
            "base-${GPU}-stack"|"*-${GPU}"|"all-templates")
              echo "should-build=true" >> $GITHUB_OUTPUT
              echo "ðŸ”¨ Will build base-${GPU}"
              ;;
            "base-common-only")
              echo "should-build=false" >> $GITHUB_OUTPUT
              echo "â­ï¸ Skipping base-${GPU} (common-only requested)"
              ;;
            *)
              if [[ "$TARGET" == *"$GPU"* ]]; then
                echo "should-build=true" >> $GITHUB_OUTPUT
              else
                echo "should-build=false" >> $GITHUB_OUTPUT
                echo "â­ï¸ Skipping base-${GPU} (not needed for $TARGET)"
              fi
              ;;
          esac

      - name: Check if image exists
        id: check
        if: steps.should-build.outputs.should-build == 'true'
        run: |
          if [ "${{ inputs.force_rebuild }}" = "true" ]; then
            echo "should-skip=false" >> $GITHUB_OUTPUT
          elif docker manifest inspect ${{ env.REGISTRY }}/aiclipse-base-${{ matrix.gpu }}:${{ env.VERSION }} >/dev/null 2>&1; then
            echo "should-skip=true" >> $GITHUB_OUTPUT
            echo "âœ… base-${{ matrix.gpu }} exists, skipping"
          else
            echo "should-skip=false" >> $GITHUB_OUTPUT
            echo "ðŸ”¨ base-${{ matrix.gpu }} missing, will build"
          fi

      - name: Checkout
        if: steps.should-build.outputs.should-build == 'true' && steps.check.outputs.should-skip == 'false'
        uses: actions/checkout@v4

      - name: Free disk space
        if: steps.should-build.outputs.should-build == 'true' && steps.check.outputs.should-skip == 'false'
        run: |
          sudo rm -rf /usr/share/dotnet /opt/ghc /usr/local/share/boost
          df -h

      - name: Set up Docker Buildx
        if: steps.should-build.outputs.should-build == 'true' && steps.check.outputs.should-skip == 'false'
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        if: steps.should-build.outputs.should-build == 'true' && steps.check.outputs.should-skip == 'false'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push base-${{ matrix.gpu }}
        if: steps.should-build.outputs.should-build == 'true' && steps.check.outputs.should-skip == 'false'
        run: |
          docker buildx bake base-${{ matrix.gpu }} \
            --set base-${{ matrix.gpu }}.cache-from=type=gha,scope=base-${{ matrix.gpu }} \
            --set base-${{ matrix.gpu }}.cache-to=type=gha,mode=max,scope=base-${{ matrix.gpu }} \
            --push

  # Step 3: Build templates (depend on GPU bases)
  build-templates:
    runs-on: ubuntu-latest
    needs: [build-base-common, build-gpu-bases]
    if: ${{ !cancelled() && !failure() }}
    permissions:
      contents: read
      packages: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - template: sd15-basic
            gpu: rtx4090
          - template: sd15-basic
            gpu: rtx5090
          - template: story-processing
            gpu: rtx4090
          - template: story-processing
            gpu: rtx5090
    steps:
      - name: Should build this template?
        id: should-build
        run: |
          TARGET="${{ inputs.target || 'all-templates' }}"
          TEMPLATE="${{ matrix.template }}"
          GPU="${{ matrix.gpu }}"
          FULL_NAME="${TEMPLATE}-${GPU}"

          case "$TARGET" in
            "$FULL_NAME"|"all-templates")
              echo "should-build=true" >> $GITHUB_OUTPUT
              echo "ðŸ”¨ Will build $FULL_NAME"
              ;;
            "base-"*)
              echo "should-build=false" >> $GITHUB_OUTPUT
              echo "â­ï¸ Skipping $FULL_NAME (base-only build)"
              ;;
            *)
              echo "should-build=false" >> $GITHUB_OUTPUT
              echo "â­ï¸ Skipping $FULL_NAME (not selected)"
              ;;
          esac

      - name: Checkout
        if: steps.should-build.outputs.should-build == 'true'
        uses: actions/checkout@v4

      - name: Free disk space
        if: steps.should-build.outputs.should-build == 'true'
        run: |
          sudo rm -rf /usr/share/dotnet /opt/ghc
          df -h

      - name: Set up Docker Buildx
        if: steps.should-build.outputs.should-build == 'true'
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        if: steps.should-build.outputs.should-build == 'true'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push ${{ matrix.template }}-${{ matrix.gpu }}
        if: steps.should-build.outputs.should-build == 'true'
        run: |
          docker buildx bake ${{ matrix.template }}-${{ matrix.gpu }} \
            --set ${{ matrix.template }}-${{ matrix.gpu }}.cache-from=type=gha,scope=${{ matrix.template }}-${{ matrix.gpu }} \
            --set ${{ matrix.template }}-${{ matrix.gpu }}.cache-to=type=gha,mode=max,scope=${{ matrix.template }}-${{ matrix.gpu }} \
            --push

  # Summary
  build-summary:
    runs-on: ubuntu-latest
    needs: [build-base-common, build-gpu-bases, build-templates]
    if: always()
    steps:
      - name: Build Summary
        run: |
          echo "## ðŸš€ Build Complete" >> $GITHUB_STEP_SUMMARY
          echo "**Target**: ${{ inputs.target || 'auto (push)' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Force Rebuild**: ${{ inputs.force_rebuild }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Registry**: ${{ env.REGISTRY }}" >> $GITHUB_STEP_SUMMARY
          echo "**Version**: ${{ env.VERSION }}" >> $GITHUB_STEP_SUMMARY
