# .github/workflows/build.yml - BULLETPROOF VERSION

name: Build ComfyUI Templates

on:
  push:
    branches: [main]
    paths:
      - 'base/**'
      - 'templates/**'
      - 'docker-bake.hcl'

  workflow_dispatch:
    inputs:
      build_target:
        description: 'What to build'
        required: true
        type: choice
        default: 'changed-files'
        options:
          - 'changed-files'
          - 'all'
          - 'base-common'
          - 'base-rtx4090'
          - 'base-rtx5090'
          - 'boomboom-rtx5090'
          - 'sd15-basic-rtx4090'
          - 'sd15-basic-rtx5090'
      force_rebuild:
        description: 'Force rebuild (ignore cache)'
        required: false
        type: boolean
        default: false

env:
  REGISTRY: ghcr.io/${{ github.repository_owner }}
  VERSION: ${{ github.ref_name || 'latest' }}

jobs:
  # âœ… SAFE: Always runs, determines what to build
  determine-builds:
    runs-on: ubuntu-latest
    outputs:
      should-build-base-common: ${{ steps.check.outputs.should-build-base-common }}
      should-build-base-rtx4090: ${{ steps.check.outputs.should-build-base-rtx4090 }}
      should-build-base-rtx5090: ${{ steps.check.outputs.should-build-base-rtx5090 }}
      should-build-boomboom: ${{ steps.check.outputs.should-build-boomboom }}
      should-build-sd15-4090: ${{ steps.check.outputs.should-build-sd15-4090 }}
      should-build-sd15-5090: ${{ steps.check.outputs.should-build-sd15-5090 }}
    steps:
      - name: Checkout (lightweight)
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check file changes (for push events)
        id: files
        if: github.event_name == 'push'
        run: |
          # Check what changed
          BASE_CHANGED="false"
          BOOMBOOM_CHANGED="false"
          SD15_CHANGED="false"

          if git diff --name-only HEAD^ HEAD | grep -E '^(base/|manifests/base_nodes.txt|docker-bake.hcl)'; then
            BASE_CHANGED="true"
            echo "ðŸ”¥ Base files changed"
          fi

          if git diff --name-only HEAD^ HEAD | grep '^templates/boomboom/'; then
            BOOMBOOM_CHANGED="true"
            echo "ðŸŽ¨ Boomboom template changed"
          fi

          if git diff --name-only HEAD^ HEAD | grep '^templates/sd15-basic/'; then
            SD15_CHANGED="true"
            echo "ðŸŽ¨ SD15-basic template changed"
          fi

          echo "base-changed=$BASE_CHANGED" >> $GITHUB_OUTPUT
          echo "boomboom-changed=$BOOMBOOM_CHANGED" >> $GITHUB_OUTPUT
          echo "sd15-changed=$SD15_CHANGED" >> $GITHUB_OUTPUT

      - name: Determine what to build
        id: check
        run: |
          BUILD_TARGET="${{ inputs.build_target || 'changed-files' }}"
          BASE_CHANGED="${{ steps.files.outputs.base-changed || 'false' }}"
          BOOMBOOM_CHANGED="${{ steps.files.outputs.boomboom-changed || 'false' }}"
          SD15_CHANGED="${{ steps.files.outputs.sd15-changed || 'false' }}"

          # Initialize all to false (CRITICAL: no quotes around false)
          BUILD_BASE_COMMON=false
          BUILD_BASE_RTX4090=false
          BUILD_BASE_RTX5090=false
          BUILD_BOOMBOOM=false
          BUILD_SD15_4090=false
          BUILD_SD15_5090=false

          echo "ðŸ“‹ Build target: $BUILD_TARGET"
          echo "ðŸ“ Changes: base=$BASE_CHANGED, boomboom=$BOOMBOOM_CHANGED, sd15=$SD15_CHANGED"

          case "$BUILD_TARGET" in
            "all")
              BUILD_BASE_COMMON=true
              BUILD_BASE_RTX4090=true
              BUILD_BASE_RTX5090=true
              BUILD_BOOMBOOM=true
              BUILD_SD15_4090=true
              BUILD_SD15_5090=true
              echo "ðŸ”„ Building everything"
              ;;
            "base-common")
              BUILD_BASE_COMMON=true
              ;;
            "base-rtx4090")
              BUILD_BASE_RTX4090=true
              ;;
            "base-rtx5090")
              BUILD_BASE_RTX5090=true
              ;;
            "boomboom-rtx5090")
              BUILD_BASE_RTX5090=true
              BUILD_BOOMBOOM=true
              ;;
            "sd15-basic-rtx4090")
              BUILD_BASE_RTX4090=true
              BUILD_SD15_4090=true
              ;;
            "sd15-basic-rtx5090")
              BUILD_BASE_RTX5090=true
              BUILD_SD15_5090=true
              ;;
            "changed-files")
              if [[ "$BASE_CHANGED" == "true" ]]; then
                # Base changed - rebuild everything
                BUILD_BASE_COMMON=true
                BUILD_BASE_RTX4090=true
                BUILD_BASE_RTX5090=true
                BUILD_BOOMBOOM=true
                BUILD_SD15_4090=false
                BUILD_SD15_5090=false
                echo "ðŸ”¥ Base changed - rebuilding all"
              else
                # Only templates changed
                if [[ "$BOOMBOOM_CHANGED" == "true" ]]; then
                  BUILD_BOOMBOOM=true
                  echo "ðŸŽ¨ Only boomboom changed"
                fi
                if [[ "$SD15_CHANGED" == "true" ]]; then
                  BUILD_SD15_4090=true
                  BUILD_SD15_5090=true
                  echo "ðŸŽ¨ Only sd15-basic changed"
                fi
              fi
              ;;
          esac

          # âœ… CRITICAL: Output as string true/false (not boolean)
          echo "should-build-base-common=$BUILD_BASE_COMMON" >> $GITHUB_OUTPUT
          echo "should-build-base-rtx4090=$BUILD_BASE_RTX4090" >> $GITHUB_OUTPUT
          echo "should-build-base-rtx5090=$BUILD_BASE_RTX5090" >> $GITHUB_OUTPUT
          echo "should-build-boomboom=$BUILD_BOOMBOOM" >> $GITHUB_OUTPUT
          echo "should-build-sd15-4090=$BUILD_SD15_4090" >> $GITHUB_OUTPUT
          echo "should-build-sd15-5090=$BUILD_SD15_5090" >> $GITHUB_OUTPUT

          echo "ðŸŽ¯ Final build plan:"
          echo "  base-common: $BUILD_BASE_COMMON"
          echo "  base-rtx4090: $BUILD_BASE_RTX4090"
          echo "  base-rtx5090: $BUILD_BASE_RTX5090"
          echo "  boomboom: $BUILD_BOOMBOOM"
          echo "  sd15-4090: $BUILD_SD15_4090"
          echo "  sd15-5090: $BUILD_SD15_5090"

  # âœ… BULLETPROOF: Job-level condition prevents job from starting
  build-base-common:
    runs-on: ubuntu-latest
    needs: [determine-builds]
    if: needs.determine-builds.outputs.should-build-base-common == 'true'
    permissions:
      contents: read
      packages: write
    steps:
      - name: Free up disk space
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: false
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: false
          swap-storage: true

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Build Environment
        uses: ./.github/actions/setup-build-env
        with:
          gh_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push base-common
        run: |
          EXTRA_ARGS=""
          if [ "${{ inputs.force_rebuild }}" = "true" ]; then
            EXTRA_ARGS="--no-cache"
          fi
          docker buildx bake base-common --push $EXTRA_ARGS

  # âœ… RTX 4090 base - only if needed
  build-base-rtx4090:
    runs-on: ubuntu-latest
    needs: [determine-builds, build-base-common]
    if: |
      always() &&
      !cancelled() &&
      needs.determine-builds.outputs.should-build-base-rtx4090 == 'true' &&
      (needs.build-base-common.result == 'success' || needs.build-base-common.result == 'skipped')
    permissions:
      contents: read
      packages: write
    steps:
      - name: Free up disk space
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: false
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: false
          swap-storage: true

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Build Environment
        uses: ./.github/actions/setup-build-env
        with:
          gh_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push base-rtx4090
        run: |
          EXTRA_ARGS=""
          if [ "${{ inputs.force_rebuild }}" = "true" ]; then
            EXTRA_ARGS="--no-cache"
          fi
          docker buildx bake base-rtx4090 --push $EXTRA_ARGS

  # âœ… RTX 5090 base - only if needed
  build-base-rtx5090:
    runs-on: ubuntu-latest
    needs: [determine-builds, build-base-common]
    if: |
      always() &&
      !cancelled() &&
      needs.determine-builds.outputs.should-build-base-rtx5090 == 'true' &&
      (needs.build-base-common.result == 'success' || needs.build-base-common.result == 'skipped')
    permissions:
      contents: read
      packages: write
    steps:
      - name: Free up disk space
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: false
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: false
          swap-storage: true

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Build Environment
        uses: ./.github/actions/setup-build-env
        with:
          gh_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push base-rtx5090
        run: |
          EXTRA_ARGS=""
          if [ "${{ inputs.force_rebuild }}" = "true" ]; then
            EXTRA_ARGS="--no-cache"
          fi
          docker buildx bake base-rtx5090 --push $EXTRA_ARGS

  # âœ… Boomboom template
  build-boomboom:
    runs-on: ubuntu-latest
    needs: [determine-builds, build-base-rtx5090]
    if: |
      always() &&
      !cancelled() &&
      needs.determine-builds.outputs.should-build-boomboom == 'true' &&
      (needs.build-base-rtx5090.result == 'success' || needs.build-base-rtx5090.result == 'skipped')
    permissions:
      contents: read
      packages: write
    steps:
      - name: Free up disk space
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: false
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: false
          swap-storage: true

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Build Environment
        uses: ./.github/actions/setup-build-env
        with:
          gh_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push boomboom-rtx5090
        run: |
          EXTRA_ARGS=""
          if [ "${{ inputs.force_rebuild }}" = "true" ]; then
            EXTRA_ARGS="--no-cache"
          fi
          docker buildx bake boomboom-rtx5090 --push $EXTRA_ARGS

  # âœ… Summary job
  build-summary:
    runs-on: ubuntu-latest
    needs: [determine-builds, build-base-common, build-base-rtx4090, build-base-rtx5090, build-boomboom]
    if: always()
    steps:
      - name: Build Summary
        run: |
          echo "## ðŸš€ Build Complete" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Target**: ${{ inputs.build_target || 'changed-files' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Results**:" >> $GITHUB_STEP_SUMMARY
          echo "- determine-builds: ${{ needs.determine-builds.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- build-base-common: ${{ needs.build-base-common.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- build-base-rtx4090: ${{ needs.build-base-rtx4090.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- build-base-rtx5090: ${{ needs.build-base-rtx5090.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- build-boomboom: ${{ needs.build-boomboom.result }}" >> $GITHUB_STEP_SUMMARY
