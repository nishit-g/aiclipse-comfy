# .github/workflows/build.yml - BEST PRACTICE VERSION

name: Build ComfyUI Templates

on:
  # Trigger 1: Automatic on push to main
  push:
    branches: [main]
    paths:
      - 'base/**'
      - 'templates/**'
      - 'docker-bake.hcl'

  # Trigger 2: Manual from the Actions tab - IMPROVED VERSION
  workflow_dispatch:
    inputs:
      build_target:
        description: 'What to build'
        required: true
        type: choice  # âœ… Use choice instead of string
        default: 'changed-files'  # âœ… Smart default
        options:
          - 'changed-files'     # Only build what changed (smart)
          - 'all'              # Build everything
          - 'bases'            # Base images only
          - 'base-common'      # Common base only
          - 'base-rtx4090'     # RTX 4090 base only
          - 'base-rtx5090'     # RTX 5090 base only
          - 'sd15-basic'       # SD15 templates only
          - 'boomboom'         # Boomboom template only

      force_rebuild:
        description: 'Ignore cache and rebuild everything'
        required: false
        type: boolean
        default: false

env:
  REGISTRY: ghcr.io/${{ github.repository_owner }}
  VERSION: ${{ github.ref_name || 'latest' }}

jobs:
  # NEW: Change detection job for smart builds
  detect-changes:
    runs-on: ubuntu-latest
    # Only run on push events or when 'changed-files' is selected
    if: github.event_name == 'push' || inputs.build_target == 'changed-files'
    outputs:
      base-changed: ${{ steps.changes.outputs.base }}
      templates-changed: ${{ steps.changes.outputs.templates }}
      boomboom-changed: ${{ steps.changes.outputs.boomboom }}
      sd15-changed: ${{ steps.changes.outputs.sd15 }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - uses: dorny/paths-filter@v2
        id: changes
        with:
          filters: |
            base:
              - 'base/**'
              - 'manifests/base_nodes.txt'
              - 'docker-bake.hcl'
            templates:
              - 'templates/**'
            boomboom:
              - 'templates/boomboom/**'
            sd15:
              - 'templates/sd15-basic/**'

  build-base-common:
    runs-on: ubuntu-latest
    needs: [detect-changes]
    if: |
      !cancelled() &&
      (
        inputs.build_target == 'all' ||
        inputs.build_target == 'bases' ||
        inputs.build_target == 'base-common' ||
        (inputs.build_target == 'changed-files' && needs.detect-changes.outputs.base-changed == 'true') ||
        (github.event_name == 'push' && needs.detect-changes.outputs.base-changed == 'true')
      )
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Build Environment
        uses: ./.github/actions/setup-build-env
        with:
          gh_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push base-common
        run: |
          EXTRA_ARGS=""
          if [ "${{ inputs.force_rebuild }}" = "true" ]; then
            EXTRA_ARGS="--no-cache"
          fi
          docker buildx bake base-common --push $EXTRA_ARGS

  build-gpu-bases:
    runs-on: ubuntu-latest
    needs: [detect-changes, build-base-common]
    if: ${{ !cancelled() && !failure() }}
    permissions:
      contents: read
      packages: write
    strategy:
      fail-fast: false
      matrix:
        gpu: [rtx4090, rtx5090]
    steps:
      - name: Should build this GPU base?
        id: should-build
        run: |
          BUILD_TARGET="${{ inputs.build_target || 'changed-files' }}"
          GPU_BASE="base-${{ matrix.gpu }}"

          SHOULD_BUILD="false"

          # Build logic based on choice
          case "$BUILD_TARGET" in
            "all"|"bases")
              SHOULD_BUILD="true"
              echo "âœ… Building $GPU_BASE (target: $BUILD_TARGET)"
              ;;
            "base-${{ matrix.gpu }}")
              SHOULD_BUILD="true"
              echo "âœ… Building $GPU_BASE (explicitly requested)"
              ;;
            "boomboom")
              if [[ "${{ matrix.gpu }}" == "rtx5090" ]]; then
                SHOULD_BUILD="true"
                echo "âœ… Building $GPU_BASE (needed for boomboom)"
              fi
              ;;
            "sd15-basic")
              if [[ "${{ matrix.gpu }}" == "rtx4090" ]]; then
                SHOULD_BUILD="true"
                echo "âœ… Building $GPU_BASE (needed for sd15-basic)"
              fi
              ;;
            "changed-files")
              if [[ "${{ needs.detect-changes.outputs.base-changed }}" == "true" ]]; then
                SHOULD_BUILD="true"
                echo "âœ… Building $GPU_BASE (base files changed)"
              else
                echo "â­ï¸ Skipping $GPU_BASE (only template files changed)"
              fi
              ;;
            *)
              echo "â­ï¸ Skipping $GPU_BASE (not needed for $BUILD_TARGET)"
              ;;
          esac

          echo "should-build=$SHOULD_BUILD" >> $GITHUB_OUTPUT

      - name: Checkout repository
        if: steps.should-build.outputs.should-build == 'true'
        uses: actions/checkout@v4

      - name: Setup Build Environment
        if: steps.should-build.outputs.should-build == 'true'
        uses: ./.github/actions/setup-build-env
        with:
          gh_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push base-${{ matrix.gpu }}
        if: steps.should-build.outputs.should-build == 'true'
        run: |
          EXTRA_ARGS=""
          if [ "${{ inputs.force_rebuild }}" = "true" ]; then
            EXTRA_ARGS="--no-cache"
          fi
          # âœ… Trust the bake file cache settings
          docker buildx bake base-${{ matrix.gpu }} --push $EXTRA_ARGS

  build-templates:
    runs-on: ubuntu-latest
    needs: [detect-changes, build-gpu-bases]
    if: ${{ !cancelled() && !failure() }}
    permissions:
      contents: read
      packages: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - template: sd15-basic
            gpu: rtx4090
          - template: sd15-basic
            gpu: rtx5090
          - template: boomboom
            gpu: rtx5090

    steps:
      - name: Should build this template?
        id: should-build
        run: |
          BUILD_TARGET="${{ inputs.build_target || 'changed-files' }}"
          TEMPLATE_GPU="${{ matrix.template }}-${{ matrix.gpu }}"

          SHOULD_BUILD="false"

          case "$BUILD_TARGET" in
            "all")
              SHOULD_BUILD="true"
              echo "âœ… Building $TEMPLATE_GPU (build all)"
              ;;
            "${{ matrix.template }}")
              SHOULD_BUILD="true"
              echo "âœ… Building $TEMPLATE_GPU (template requested)"
              ;;
            "changed-files")
              if [[ "${{ needs.detect-changes.outputs.base-changed }}" == "true" ]]; then
                SHOULD_BUILD="true"
                echo "âœ… Building $TEMPLATE_GPU (base changed)"
              elif [[ "${{ matrix.template }}" == "boomboom" && "${{ needs.detect-changes.outputs.boomboom-changed }}" == "true" ]]; then
                SHOULD_BUILD="true"
                echo "âœ… Building $TEMPLATE_GPU (boomboom changed)"
              elif [[ "${{ matrix.template }}" == "sd15-basic" && "${{ needs.detect-changes.outputs.sd15-changed }}" == "true" ]]; then
                SHOULD_BUILD="true"
                echo "âœ… Building $TEMPLATE_GPU (sd15-basic changed)"
              fi
              ;;
            *)
              echo "â­ï¸ Skipping $TEMPLATE_GPU (not requested)"
              ;;
          esac

          echo "should-build=$SHOULD_BUILD" >> $GITHUB_OUTPUT

      - name: Checkout repository
        if: steps.should-build.outputs.should-build == 'true'
        uses: actions/checkout@v4

      - name: Setup Build Environment
        if: steps.should-build.outputs.should-build == 'true'
        uses: ./.github/actions/setup-build-env
        with:
          gh_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push ${{ matrix.template }}-${{ matrix.gpu }}
        if: steps.should-build.outputs.should-build == 'true'
        run: |
          EXTRA_ARGS=""
          if [ "${{ inputs.force_rebuild }}" = "true" ]; then
            EXTRA_ARGS="--no-cache"
          fi
          # âœ… Trust the bake file cache settings
          docker buildx bake ${{ matrix.template }}-${{ matrix.gpu }} --push $EXTRA_ARGS

  build-summary:
    runs-on: ubuntu-latest
    needs: [detect-changes, build-base-common, build-gpu-bases, build-templates]
    if: always()
    steps:
      - name: Build Summary
        run: |
          echo "## ðŸš€ Build Complete" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Target**: ${{ inputs.build_target || 'auto (push)' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Force Rebuild**: ${{ inputs.force_rebuild || 'false' }}" >> $GITHUB_STEP_SUMMARY
