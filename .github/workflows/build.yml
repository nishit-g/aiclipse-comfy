name: Build ComfyUI Templates

on:
  # Trigger 1: Automatic on push to main
  push:
    branches: [main]
    paths:
      - 'base/**'
      - 'templates/**'
      - 'docker-bake.hcl'

  # Trigger 2: Manual from the Actions tab
  workflow_dispatch:
    inputs:
      targets_to_build:
        description: 'Comma-separated list of images to build (e.g., "base-rtx4090, sd15-basic-4090"), or "all".'
        required: true
        default: 'all'
        type: string
      force_rebuild:
        description: 'Force rebuild for all selected targets (ignores cache).'
        required: false
        type: boolean
        default: false

env:
  REGISTRY: ghcr.io/${{ github.repository_owner }}
  VERSION: ${{ github.ref_name || 'latest' }}

jobs:
  build-base-common:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Build Environment
        uses: ./.github/actions/setup-build-env
        with:
          gh_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push base-common
        run: |
          EXTRA_ARGS=""
          if [ "${{ inputs.force_rebuild }}" = "true" ]; then
            EXTRA_ARGS="--no-cache"
            echo "ðŸ”„ Force rebuild requested, using --no-cache"
          fi

          docker buildx bake base-common --push $EXTRA_ARGS

  build-gpu-bases:
    runs-on: ubuntu-latest
    needs: build-base-common
    if: ${{ !cancelled() && !failure() }}
    permissions:
      contents: read
      packages: write
    strategy:
      fail-fast: false
      matrix:
        gpu: [rtx4090, rtx5090]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Should build this GPU base?
        id: should-build
        run: |
          TARGETS="${{ inputs.targets_to_build || 'all' }}"
          GPU_BASE="base-${{ matrix.gpu }}"
          # Build if explicitly requested OR if a template depending on it is requested.
          if [[ "$TARGETS" == "all" || "$TARGETS" == *"$GPU_BASE"* || "$TARGETS" == *"-${{ matrix.gpu }}"* ]]; then
            echo "should-build=true" >> $GITHUB_OUTPUT
            echo "âœ… Will build base-${{ matrix.gpu }} as it (or a dependency) was requested."
          else
            echo "should-build=false" >> $GITHUB_OUTPUT
            echo "â­ï¸ Skipping base-${{ matrix.gpu }} (not requested)."
          fi

      - name: Setup and Build
        if: steps.should-build.outputs.should-build == 'true'
        uses: ./.github/actions/setup-build-env
        with:
          gh_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push base-${{ matrix.gpu }}
        if: steps.should-build.outputs.should-build == 'true'
        run: |
          EXTRA_ARGS=""
          if [ "${{ inputs.force_rebuild }}" = "true" ]; then
            EXTRA_ARGS="--no-cache"
          fi
          docker buildx bake base-${{ matrix.gpu }} \
            --set "*.cache-from=type=gha" \
            --set "*.cache-to=type=gha,mode=max" \
            --push $EXTRA_ARGS

  build-templates:
    runs-on: ubuntu-latest
    needs: build-gpu-bases
    if: ${{ !cancelled() && !failure() }}
    permissions:
      contents: read
      packages: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - template: sd15-basic
            gpu: rtx4090
          - template: sd15-basic
            gpu: rtx5090

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Should build this template?
        id: should-build
        run: |
          TARGETS="${{ inputs.targets_to_build || 'all' }}"
          FULL_NAME="${{ matrix.template }}-${{ matrix.gpu }}"
          if [[ "$TARGETS" == "all" || "$TARGETS" == *"$FULL_NAME"* ]]; then
            echo "should-build=true" >> $GITHUB_OUTPUT
            echo "âœ… Will build $FULL_NAME (explicitly requested)."
          else
            echo "should-build=false" >> $GITHUB_OUTPUT
            echo "â­ï¸ Skipping $FULL_NAME (not requested)."
          fi

      - name: Setup and Build
        if: steps.should-build.outputs.should-build == 'true'
        uses: ./.github/actions/setup-build-env
        with:
          gh_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push ${{ matrix.template }}-${{ matrix.gpu }}
        if: steps.should-build.outputs.should-build == 'true'
        run: |
          EXTRA_ARGS=""
          if [ "${{ inputs.force_rebuild }}" = "true" ]; then
            EXTRA_ARGS="--no-cache"
          fi
          docker buildx bake ${{ matrix.template }}-${{ matrix.gpu }} \
            --set "*.cache-from=type=gha" \
            --set "*.cache-to=type=gha,mode=max" \
            --push $EXTRA_ARGS

  build-summary:
    runs-on: ubuntu-latest
    needs: [build-base-common, build-gpu-bases, build-templates]
    if: always()
    steps:
      - name: Build Summary
        run: |
          echo "## ðŸš€ Build Complete" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Targets**: ${{ inputs.targets_to_build || 'all (push)' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Force Rebuild**: ${{ inputs.force_rebuild }}" >> $GITHUB_STEP_SUMMARY
