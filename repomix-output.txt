This file is a merged representation of the entire codebase, combining all repository files into a single document.
Generated by Repomix on: 2025-08-22T21:42:32.427Z

================================================================
File Summary
================================================================

Purpose:
--------
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.

File Format:
------------
The content is organized as follows:
1. This summary section
2. Repository information
3. Repository structure
4. Multiple file entries, each consisting of:
  a. A separator line (================)
  b. The file path (File: path/to/file)
  c. Another separator line
  d. The full contents of the file
  e. A blank line

Usage Guidelines:
-----------------
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.

Notes:
------
- Some files may have been excluded based on .gitignore rules and Repomix's
  configuration.
- Binary files are not included in this packed representation. Please refer to
  the Repository Structure section for a complete list of file paths, including
  binary files.

Additional Info:
----------------

For more information about Repomix, visit: https://github.com/yamadashy/repomix

================================================================
Repository Structure
================================================================
.github/
  workflows/
    build.yml
base/
  scripts/
    download_models.py
    setup_models.sh
    setup_nodes.sh
    setup_services.sh
    setup_symlinks.sh
    setup_sync.sh
    start.sh
  common.dockerfile
  rtx4090.dockerfile
  rtx5090.dockerfile
manifests/
  base_nodes.txt
scripts/
  build.sh
  configure.sh
templates/
  sd15-basic/
    workflows/
      basic.json
    Dockerfile
    models_manifest.txt
    nodes_manifest.txt
    README.md
.env.template
.gitignore
docker-bake.hcl
README.md
TEMPLATE_GUIDE.md

================================================================
Repository Files
================================================================

================
File: .github/workflows/build.yml
================
name: Build and Push Images
on:
  push:
    branches: [main]
    tags: ['v*']

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    - name: Login to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    - name: Build and push
      run: |
        export REGISTRY=ghcr.io/${{ github.repository_owner }}
        export VERSION=${{ github.ref_name }}
        ./scripts/build.sh all

================
File: base/scripts/download_models.py
================
#!/usr/bin/env python3
import argparse
import os
import sys
from pathlib import Path
from huggingface_hub import hf_hub_download, snapshot_download


def log(message):
    print(f"[MODELS] {message}", flush=True)


def download_from_manifest(manifest_file, models_dir, token=None):
    """Download models from manifest file"""
    models_dir = Path(models_dir)
    models_dir.mkdir(parents=True, exist_ok=True)

    success_count = 0
    error_count = 0

    with open(manifest_file, "r", encoding="utf-8") as f:
        for line_num, line in enumerate(f, 1):
            line = line.strip()

            # Skip comments and empty lines
            if not line or line.startswith("#"):
                continue

            try:
                # Parse manifest line: repo|filename|subdir
                parts = line.split("|", 2)
                if len(parts) != 3:
                    log(f"Line {line_num}: Invalid format, skipping: {line}")
                    continue

                repo_id, filename, subdir = parts

                # Create target directory
                target_dir = models_dir / subdir
                target_dir.mkdir(parents=True, exist_ok=True)

                # Download file
                log(f"Downloading {repo_id}/{filename} -> {subdir}/")
                downloaded_path = hf_hub_download(
                    repo_id=repo_id,
                    filename=filename,
                    local_dir=target_dir,
                    token=token,
                )

                success_count += 1
                log(f"âœ… Downloaded: {downloaded_path}")

            except Exception as e:
                error_count += 1
                log(f"âŒ Failed {repo_id}/{filename}: {e}")

    log(f"Download complete: {success_count} success, {error_count} errors")
    return error_count == 0


def main():
    parser = argparse.ArgumentParser(description="Download models from manifest")
    parser.add_argument("--manifest", required=True, help="Manifest file path")
    parser.add_argument("--models-dir", required=True, help="Models directory")
    parser.add_argument(
        "--token", default=os.getenv("HF_TOKEN"), help="Hugging Face token"
    )

    args = parser.parse_args()

    if not os.path.exists(args.manifest):
        log(f"Manifest file not found: {args.manifest}")
        return 1

    try:
        success = download_from_manifest(args.manifest, args.models_dir, args.token)
        return 0 if success else 1
    except Exception as e:
        log(f"Download failed: {e}")
        return 1


if __name__ == "__main__":
    sys.exit(main())

================
File: base/scripts/setup_models.sh
================
#!/bin/bash

setup_model_paths() {
    log "ğŸ¯ Configuring ComfyUI model paths..."

    # Create extra_model_paths.yaml
    cat > "$COMFY_DIR/extra_model_paths.yaml" << 'YAML'
models:
  checkpoints: /workspace/aiclipse/models/checkpoints
  diffusion_models: /workspace/aiclipse/models/diffusion_models
  vae: /workspace/aiclipse/models/vae
  loras: /workspace/aiclipse/models/loras
  clip: /workspace/aiclipse/models/clip
  controlnet: /workspace/aiclipse/models/controlnet
  upscale_models: /workspace/aiclipse/models/upscale_models
  embeddings: /workspace/aiclipse/models/embeddings
YAML

    log "âœ… Model paths configured"
}

download_models_async() {
    local manifest_file="/workspace/aiclipse/models_manifest.txt"

    # Use template-specific manifest if available, otherwise no default models
    if [ ! -f "$manifest_file" ]; then
        if [ -f "/manifests/${TEMPLATE_TYPE}_models.txt" ]; then
            cp "/manifests/${TEMPLATE_TYPE}_models.txt" "$manifest_file"
            log "ğŸ“‹ Created manifest from template: ${TEMPLATE_TYPE}"
        else
            log "â„¹ï¸ No model manifest found - starting with empty model directory"
            return 0
        fi
    fi

    # Start async download if manifest exists and enabled
    if [ -f "$manifest_file" ] && [ "$DOWNLOAD_MODELS" = "true" ]; then
        log "ğŸ“¥ Starting model downloads in background..."
        nohup /venv/bin/python /scripts/download_models.py \
            --manifest "$manifest_file" \
            --models-dir "$MODELS_DIR" \
            > /workspace/aiclipse/logs/models.log 2>&1 &

        log "ğŸ“Š Model download log: /workspace/aiclipse/logs/models.log"
    fi
}

================
File: base/scripts/setup_nodes.sh
================
#!/bin/bash

setup_custom_nodes() {
    log "ğŸ”Œ Setting up custom nodes..."

    local nodes_manifest="/workspace/custom_nodes_manifest.txt"
    local comfyui_dir="/workspace/aiclipse/ComfyUI"
    local nodes_dir="$comfyui_dir/custom_nodes"

    # Create default manifest if none exists
    if [ ! -f "$nodes_manifest" ] && [ -f "/manifests/headshots_nodes.txt" ]; then
        cp "/manifests/headshots_nodes.txt" "$nodes_manifest"
        log "ğŸ“‹ Created default custom nodes manifest"
    fi

    # Skip if no manifest
    if [ ! -f "$nodes_manifest" ]; then
        log "â„¹ï¸ No custom nodes manifest found, skipping"
        return 0
    fi

    log "ğŸ“¦ Installing custom nodes from manifest..."

    # Process each line in manifest
    while IFS='|' read -r repo_url branch category description || [ -n "$repo_url" ]; do
        # Skip comments and empty lines
        [[ $repo_url =~ ^[[:space:]]*# ]] && continue
        [[ -z "$repo_url" ]] && continue

        local node_name=$(basename "$repo_url" .git)
        local node_path="$nodes_dir/$node_name"

        # Check if already installed
        if [ -d "$node_path" ]; then
            log "âœ… $node_name already installed"
            continue
        fi

        log "ğŸ”§ Installing $node_name ($category)..."

        # Clone repository
        if git clone --depth 1 -b "${branch:-main}" "$repo_url" "$node_path" 2>/dev/null; then
            cd "$node_path"

            # Install requirements if present
            if [ -f "requirements.txt" ]; then
                log "ğŸ“‹ Installing requirements for $node_name..."
                /venv/bin/pip install --no-cache-dir -r requirements.txt || {
                    log "âš ï¸ Failed to install requirements for $node_name"
                }
            fi

            # Run install script if present
            if [ -f "install.py" ]; then
                log "ğŸ”§ Running install script for $node_name..."
                /venv/bin/python install.py || {
                    log "âš ï¸ Install script failed for $node_name"
                }
            fi

            log "âœ… Installed $node_name"
        else
            log "âŒ Failed to clone $node_name from $repo_url"
        fi

        cd "$comfyui_dir"

    done < "$nodes_manifest"

    log "ğŸ‰ Custom nodes installation complete"
}

# Python version for more robust handling
setup_custom_nodes_python() {
    log "ğŸ”Œ Setting up custom nodes (Python)..."

    /venv/bin/python3 << 'PYTHON_SCRIPT'
import os
import sys
import subprocess
import urllib.parse
from pathlib import Path

def log(message):
    print(f"[NODES] {message}", flush=True)

def install_custom_nodes():
    nodes_manifest = "/workspace/custom_nodes_manifest.txt"
    comfyui_dir = Path("/workspace/aiclipse/ComfyUI")
    nodes_dir = comfyui_dir / "custom_nodes"

    if not Path(nodes_manifest).exists():
        log("No custom nodes manifest found, skipping")
        return

    nodes_dir.mkdir(exist_ok=True)

    with open(nodes_manifest, 'r') as f:
        for line_num, line in enumerate(f, 1):
            line = line.strip()

            # Skip comments and empty lines
            if not line or line.startswith('#'):
                continue

            try:
                parts = line.split('|')
                if len(parts) < 2:
                    log(f"Line {line_num}: Invalid format, skipping: {line}")
                    continue

                repo_url = parts[0].strip()
                branch = parts[1].strip() if len(parts) > 1 and parts[1].strip() else "main"
                category = parts[2].strip() if len(parts) > 2 else "general"

                # Extract repo name
                parsed_url = urllib.parse.urlparse(repo_url)
                repo_name = Path(parsed_url.path).stem
                node_path = nodes_dir / repo_name

                if node_path.exists():
                    log(f"âœ… {repo_name} already installed")
                    continue

                log(f"ğŸ”§ Installing {repo_name} ({category})...")

                # Clone repository
                result = subprocess.run([
                    "git", "clone", "--depth", "1",
                    "-b", branch, repo_url, str(node_path)
                ], capture_output=True, text=True)

                if result.returncode == 0:
                    # Install requirements
                    req_file = node_path / "requirements.txt"
                    if req_file.exists():
                        log(f"ğŸ“‹ Installing requirements for {repo_name}...")
                        subprocess.run([
                            "/venv/bin/pip", "install", "--no-cache-dir",
                            "-r", str(req_file)
                        ], capture_output=True)

                    # Run install script
                    install_script = node_path / "install.py"
                    if install_script.exists():
                        log(f"ğŸ”§ Running install script for {repo_name}...")
                        subprocess.run([
                            "/venv/bin/python", str(install_script)
                        ], cwd=str(node_path), capture_output=True)

                    log(f"âœ… Installed {repo_name}")
                else:
                    log(f"âŒ Failed to clone {repo_name}: {result.stderr}")

            except Exception as e:
                log(f"âŒ Error processing line {line_num}: {e}")

if __name__ == "__main__":
    install_custom_nodes()

PYTHON_SCRIPT

    log "ğŸ‰ Custom nodes setup complete"
}

================
File: base/scripts/setup_services.sh
================
#!/bin/bash

start_all_services() {
    log "ğŸŒ Starting background services..."

    mkdir -p /workspace/aiclipse/logs

    # Start FileBrowser
    start_filebrowser

    # Start Zasper
    start_zasper

    # Start JupyterLab if enabled
    if [ "${ENABLE_JUPYTER:-true}" = "true" ]; then
        start_jupyter
    fi
}

start_filebrowser() {
    local db_file="/workspace/aiclipse/filebrowser.db"

    if [ ! -f "$db_file" ]; then
        filebrowser config init --database "$db_file"
        filebrowser config set --address 0.0.0.0 --port 8080 --root /workspace --auth.method=noauth --database "$db_file"
        filebrowser users add admin admin --database "$db_file"
    fi

    log "ğŸ“ Starting FileBrowser on port 8080..."
    nohup filebrowser --database "$db_file" > /workspace/aiclipse/logs/filebrowser.log 2>&1 &
}

start_zasper() {
    log "ğŸ“ Starting Zasper on port 8048..."
    nohup zasper --port 0.0.0.0:8048 --cwd /workspace > /workspace/aiclipse/logs/zasper.log 2>&1 &
}

start_jupyter() {
    log "ğŸª Starting JupyterLab on port 8888..."
    nohup jupyter lab \
        --ServerApp.ip=0.0.0.0 \
        --ServerApp.port=8888 \
        --ServerApp.open_browser=False \
        --ServerApp.token="${JUPYTER_TOKEN:-}" \
        --ServerApp.password='' \
        --ServerApp.allow_origin='*' \
        --ServerApp.root_dir="/workspace" \
        --ServerApp.allow_root=True \
        > /workspace/aiclipse/logs/jupyter.log 2>&1 &
}

================
File: base/scripts/setup_symlinks.sh
================
#!/bin/bash

setup_symlinks() {
    log "ğŸ”— Setting up symlinks for user convenience..."

    # Robust symlink creator (backs up existing)
    safe_link() {
        local link="$1" target="$2"
        if [ -e "$link" ] && [ ! -L "$link" ]; then
            mv "$link" "${link}.bak.$(date +%s)"
            log "ğŸ“¦ Backed up existing: $link"
        fi
        ln -sfnT "$target" "$link"
        log "ğŸ”— Linked: $link -> $target"
    }

    # Create user-friendly symlinks at /workspace root
    safe_link "/workspace/ComfyUI"   "/workspace/aiclipse/ComfyUI"
    safe_link "/workspace/workflows" "/workspace/aiclipse/workflows"
    safe_link "/workspace/input"     "/workspace/aiclipse/ComfyUI/input"
    safe_link "/workspace/output"    "/workspace/aiclipse/ComfyUI/output"
    safe_link "/workspace/models"    "/workspace/aiclipse/models"
    safe_link "/workspace/logs"      "/workspace/aiclipse/logs"

    # Additional convenience links
    if [ -d "/workspace/aiclipse/ComfyUI/custom_nodes" ]; then
        safe_link "/workspace/custom_nodes" "/workspace/aiclipse/ComfyUI/custom_nodes"
    fi
}

================
File: base/scripts/setup_sync.sh
================
#!/bin/bash

sync_template_if_needed() {
    log "ğŸ”„ Checking template version sync..."

    local existing_version="0.0.0"
    if [ -f "$TEMPLATE_VERSION_FILE" ]; then
        existing_version=$(jq -r '.template_version // "0.0.0"' "$TEMPLATE_VERSION_FILE" 2>/dev/null || echo "0.0.0")
    fi

    log "ğŸ“‹ Current: $existing_version, Template: $TEMPLATE_VERSION"

    # Version comparison
    if [ "$(printf '%s\n' "$existing_version" "$TEMPLATE_VERSION" | sort -V | head -n 1)" = "$existing_version" ]; then
        if [ "$existing_version" != "$TEMPLATE_VERSION" ]; then
            log "â¬†ï¸ Upgrading template from $existing_version to $TEMPLATE_VERSION"
            perform_sync
            save_template_json
        else
            log "âœ… Template is up to date"
        fi
    else
        log "âš ï¸ Local version ($existing_version) is newer than template ($TEMPLATE_VERSION)"
    fi
}

perform_sync() {
    log "ğŸ”„ Syncing template files..."

    # Sync ComfyUI if needed
    if [ -d "/opt/ComfyUI" ] && [ ! -d "$COMFY_DIR" ]; then
        log "ğŸ“¦ Syncing ComfyUI installation..."
        rsync -av /opt/ComfyUI/ "$COMFY_DIR/"
    fi

    # Sync workflows if available
    if [ -d "/opt/workflows" ] && [ ! -d "/workspace/aiclipse/workflows" ]; then
        log "ğŸ“‹ Syncing workflows..."
        rsync -av /opt/workflows/ /workspace/aiclipse/workflows/
    fi
}

save_template_json() {
    cat > "$TEMPLATE_VERSION_FILE" << EOF
{
    "template_name": "aiclipse-${TEMPLATE_TYPE}",
    "template_version": "${TEMPLATE_VERSION}",
    "gpu_type": "${GPU_TYPE:-unknown}",
    "build_date": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
    "features": [
        "filebrowser",
        "zasper",
        "ssh",
        "symlinks",
        "model_manifest",
        "custom_args"
    ]
}
EOF
    log "ğŸ’¾ Saved template info: $TEMPLATE_VERSION_FILE"
}

================
File: base/scripts/start.sh
================
#!/bin/bash
set -e

echo "ğŸš€ Starting AiClipse ComfyUI Template System"

# Environment setup
export TEMPLATE_VERSION="${TEMPLATE_VERSION:-1.0.0}"
export TEMPLATE_TYPE="${TEMPLATE_TYPE:-base}"
export COMFY_DIR="/workspace/aiclipse/ComfyUI"
export VENV_PATH="/venv"
export MODELS_DIR="/workspace/aiclipse/models"
export TEMPLATE_VERSION_FILE="/workspace/aiclipse/template.json"

# Source all setup modules
source /scripts/setup_symlinks.sh
source /scripts/setup_sync.sh
source /scripts/setup_models.sh
source /scripts/setup_services.sh
source /scripts/setup_nodes.sh

# Main startup sequence
main() {
    log "ğŸ”§ Setting up environment..."
    setup_environment

    log "ğŸ” Configuring SSH access..."
    setup_ssh_with_export

    log "ğŸ”— Creating symlinks..."
    setup_symlinks

    log "ğŸ”„ Checking template sync..."
    sync_template_if_needed

    log "ğŸ“¦ Setting up ComfyUI..."
    setup_comfyui

    log "ğŸ¯ Configuring model paths..."
    setup_model_paths

    log "ğŸ”Œ Installing custom nodes..."
    setup_custom_nodes

    log "ğŸ“¥ Starting model downloads..."
    download_models_async

    log "ğŸŒ Starting services..."
    start_all_services

    log "ğŸ¨ Starting ComfyUI..."
    start_comfyui_with_custom_args
}

# Logging helper
log() {
    echo "[$(date '+%H:%M:%S')] $1"
}

# Environment setup
setup_environment() {
    # Export RunPod environment for SSH sessions
    printenv | grep -E '^RUNPOD_|^CUDA|^LD_LIBRARY_PATH|^PATH' | while read -r line; do
        name=$(echo "$line" | cut -d= -f1)
        value=$(echo "$line" | cut -d= -f2-)
        echo "export $name=\"$value\"" >> /etc/rp_environment
    done
    echo 'source /etc/rp_environment' >> ~/.bashrc
    echo 'source /etc/rp_environment' >> /etc/bash.bashrc
}

# SSH setup with environment export
setup_ssh_with_export() {
    mkdir -p ~/.ssh

    # Generate host keys if missing
    for type in rsa ecdsa ed25519; do
        if [ ! -f "/etc/ssh/ssh_host_${type}_key" ]; then
            ssh-keygen -t ${type} -f "/etc/ssh/ssh_host_${type}_key" -q -N ''
        fi
    done

    # Setup authentication
    if [[ $PUBLIC_KEY ]]; then
        echo "$PUBLIC_KEY" >> ~/.ssh/authorized_keys
        chmod 600 ~/.ssh/authorized_keys
        log "âœ… SSH configured with public key"
    else
        RANDOM_PASS=$(openssl rand -base64 12)
        echo "root:${RANDOM_PASS}" | chpasswd
        log "ğŸ”‘ SSH password: ${RANDOM_PASS}"
    fi

    /usr/sbin/sshd
}

# ComfyUI setup
setup_comfyui() {
    if [ ! -d "$COMFY_DIR" ]; then
        log "ğŸ“¦ First time setup: Installing ComfyUI..."
        git clone https://github.com/comfyanonymous/ComfyUI.git "$COMFY_DIR"
        cd "$COMFY_DIR"

        # Install ComfyUI requirements
        /venv/bin/pip install --no-cache-dir -r requirements.txt

        # Install ComfyUI Manager
        cd custom_nodes
        git clone https://github.com/ltdrdata/ComfyUI-Manager
        if [ -f ComfyUI-Manager/requirements.txt ]; then
            /venv/bin/pip install --no-cache-dir -r ComfyUI-Manager/requirements.txt
        fi

        log "âœ… ComfyUI installation complete"
    else
        log "âœ… ComfyUI already installed"
    fi
}

# Custom arguments setup
setup_custom_args() {
    local args_file="/workspace/aiclipse/comfyui_args.txt"
    if [ ! -f "$args_file" ]; then
        cat > "$args_file" << 'EOF'
# Custom ComfyUI arguments (one per line)
# --lowvram
# --force-fp16
# --disable-xformers
EOF
    fi
}

# Start ComfyUI with custom arguments
start_comfyui_with_custom_args() {
    cd "$COMFY_DIR"

    setup_custom_args

    # Base arguments
    local args="--listen 0.0.0.0 --port 8188"

    # Add SageAttention if enabled
    if [ "$ENABLE_SAGE_ATTENTION" = "true" ]; then
        args="$args --use-sage-attention"
    fi

    # Add custom arguments
    local custom_args_file="/workspace/aiclipse/comfyui_args.txt"
    if [ -f "$custom_args_file" ]; then
        local custom_args=$(grep -v '^#' "$custom_args_file" | grep -v '^$' | tr '\n' ' ')
        if [ -n "$custom_args" ]; then
            args="$args $custom_args"
            log "ğŸ“ Using custom args: $custom_args"
        fi
    fi

    log "ğŸ¨ Starting ComfyUI with: $args"
    exec /venv/bin/python main.py $args
}

# Run main function
main "$@"

================
File: base/common.dockerfile
================
ARG CUDA_VERSION=12.8
FROM nvidia/cuda:${CUDA_VERSION}-cudnn-runtime-ubuntu22.04

ENV DEBIAN_FRONTEND=noninteractive
ENV PYTHONUNBUFFERED=1
ENV IMAGEIO_FFMPEG_EXE=/usr/bin/ffmpeg
ENV PATH="/venv/bin:$PATH"

# Install system dependencies
RUN apt-get update && apt-get upgrade -y && \
    apt-get install -y --no-install-recommends \
    git python3.12 python3.12-venv python3.12-dev \
    build-essential wget curl htop tmux nano vim \
    openssh-server nginx ca-certificates \
    ffmpeg jq aria2 rsync inotify-tools \
    software-properties-common gpg-agent \
    && rm -rf /var/lib/apt/lists/*

# Install modern tools
RUN curl -fsSL https://raw.githubusercontent.com/filebrowser/get/master/get.sh | bash
RUN wget https://github.com/zasper-io/zasper/releases/download/v0.1.0-alpha/zasper-webapp-linux-amd64.tar.gz && \
    tar xf zasper-webapp-linux-amd64.tar.gz -C /usr/local/bin && \
    rm zasper-webapp-linux-amd64.tar.gz

# Python setup
RUN update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.12 1 && \
    update-alternatives --set python3 /usr/bin/python3.12 && \
    curl -sS https://bootstrap.pypa.io/get-pip.py | python3.12 && \
    pip install --no-cache-dir jupyterlab uv

# SSH configuration for RunPod
RUN sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config && \
    sed -i 's/#PasswordAuthentication yes/PasswordAuthentication yes/' /etc/ssh/sshd_config && \
    echo "PermitUserEnvironment yes" >> /etc/ssh/sshd_config && \
    mkdir -p /run/sshd

# Create workspace structure
RUN mkdir -p /workspace/aiclipse/{ComfyUI,models,workflows,output,logs,temp} && \
    mkdir -p /workspace/aiclipse/models/{checkpoints,diffusion_models,vae,loras,clip,controlnet,upscale_models,embeddings}

# Copy manifests directory
COPY manifests/ /manifests/

WORKDIR /workspace/aiclipse

================
File: base/rtx4090.dockerfile
================
ARG BASE_IMAGE
FROM ${BASE_IMAGE}

ENV GPU_TYPE="rtx4090"
ENV CUDA_VERSION="12.4"
ENV TORCH_INDEX="https://download.pytorch.org/whl/cu124"
ENV TORCH_VERSION="2.6.0+cu124"
ENV XFORMERS_VERSION="0.0.29.post3"

# Create virtual environment and install PyTorch
RUN python3.12 -m venv /venv && \
    /venv/bin/pip install --no-cache-dir torch=="${TORCH_VERSION}" torchvision torchaudio --index-url ${TORCH_INDEX} && \
    /venv/bin/pip install --no-cache-dir xformers=="${XFORMERS_VERSION}" --index-url ${TORCH_INDEX} && \
    /venv/bin/pip install --no-cache-dir huggingface-hub safetensors accelerate

# Copy all setup scripts
COPY scripts/ /scripts/
RUN chmod +x /scripts/*.sh

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD curl -f http://localhost:8188/ || exit 1

EXPOSE 22 8188 8080 8888 8048
CMD ["/scripts/start.sh"]

================
File: base/rtx5090.dockerfile
================
ARG BASE_IMAGE
FROM ${BASE_IMAGE}

ENV GPU_TYPE="rtx5090"
ENV CUDA_VERSION="12.8"
ENV TORCH_INDEX="https://download.pytorch.org/whl/cu128"
ENV TORCH_VERSION="2.8.0+cu128"
ENV XFORMERS_VERSION="0.0.32.post1"
ENV ENABLE_SAGE_ATTENTION=true

# Create virtual environment and install PyTorch + SageAttention
RUN python3.12 -m venv /venv && \
    /venv/bin/pip install --no-cache-dir torch=="${TORCH_VERSION}" torchvision torchaudio --index-url ${TORCH_INDEX} && \
    /venv/bin/pip install --no-cache-dir xformers=="${XFORMERS_VERSION}" --index-url ${TORCH_INDEX} && \
    /venv/bin/pip install --no-cache-dir huggingface-hub safetensors accelerate && \
    /venv/bin/pip install --no-cache-dir triton ninja && \
    /venv/bin/pip install --no-cache-dir sageattention

# Copy all setup scripts
COPY scripts/ /scripts/
RUN chmod +x /scripts/*.sh

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD curl -f http://localhost:8188/ || exit 1

EXPOSE 22 8188 8080 8888 8048
CMD ["/scripts/start.sh"]

================
File: manifests/base_nodes.txt
================
# AiClipse Base Custom Nodes Manifest
# Format: repo_url|branch|category|description
# These nodes are installed in all templates

# Essential UI and Workflow Tools
https://github.com/rgthree/rgthree-comfy|main|ui|Essential UI improvements and workflow tools
https://github.com/pythongosssss/ComfyUI-Custom-Scripts|main|scripts|Custom script collection for better UX

# Core Utility Nodes
https://github.com/WASasquatch/was-node-suite-comfyui|main|utility|WAS node suite for image processing
https://github.com/jags111/efficiency-nodes-comfyui|main|efficiency|Efficiency nodes for optimized workflows
https://github.com/kijai/ComfyUI-KJNodes|main|utility|KJ utility nodes collection

================
File: scripts/build.sh
================
#!/bin/bash
set -e

REGISTRY=${REGISTRY:-"ghcr.io/nishit-g"}
VERSION=${VERSION:-"latest"}
TARGET=${1:-"all"}

echo "ğŸ—ï¸ Building AiClipse templates..."
echo "ğŸ“‹ Registry: $REGISTRY"
echo "ğŸ·ï¸ Version: $VERSION"
echo "ğŸ¯ Target: $TARGET"

case $TARGET in
    "bases")
        echo "ğŸ”¨ Building base images..."
        docker buildx bake bases --push
        ;;
    "4090")
        echo "ğŸ”¨ Building RTX 4090 stack..."
        docker buildx bake base-rtx4090 headshots-4090 --push
        ;;
    "5090")
        echo "ğŸ”¨ Building RTX 5090 stack..."
        docker buildx bake base-rtx5090 headshots-5090 --push
        ;;
    "sd15-basic")
        echo "ğŸ”¨ Building SD 1.5 basic templates..."
        docker buildx bake sd15-basic --push
        ;;
    "all")
        echo "ğŸ”¨ Building everything..."
        docker buildx bake all --push
        ;;
    *)
        echo "âŒ Unknown target: $TARGET"
        echo "Usage: $0 [bases|sd15-basic|4090|5090|all]"
        exit 1
        ;;
esac

echo "âœ… Build complete!"
echo "ğŸš€ Deploy images:"

================
File: scripts/configure.sh
================
#!/bin/bash
# scripts/configure.sh - Setup build environment

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

log() {
    echo -e "${BLUE}[CONFIG]${NC} $1"
}

success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# Configuration setup
setup_build_config() {
    log "ğŸ”§ Setting up build configuration..."

    # Default configuration
    export REGISTRY="${REGISTRY:-ghcr.io/nishit-g}"
    export VERSION="${VERSION:-latest}"
    export DOCKER_BUILDKIT=1
    export BUILDX_NO_DEFAULT_ATTESTATIONS=1

    # Create .env file if it doesn't exist
    if [ ! -f ".env" ]; then
        log "ğŸ“ Creating .env file from template..."
        cp env.template .env
        warn "Please edit .env file with your configuration"
    fi

    # Load environment variables
    if [ -f ".env" ]; then
        set -a
        source .env
        set +a
        log "âœ… Loaded configuration from .env"
    fi
}

# Docker setup
setup_docker() {
    log "ğŸ³ Setting up Docker environment..."

    # Check Docker installation
    if ! command -v docker &> /dev/null; then
        error "Docker is not installed"
        exit 1
    fi

    # Check Docker Buildx
    if ! docker buildx version &> /dev/null; then
        error "Docker Buildx is not available"
        exit 1
    fi

    # Create buildx builder if needed
    if ! docker buildx inspect aiclipse-builder &> /dev/null; then
        log "ğŸ—ï¸ Creating Docker Buildx builder..."
        docker buildx create --name aiclipse-builder --driver docker-container --bootstrap
        docker buildx use aiclipse-builder
    else
        docker buildx use aiclipse-builder
    fi

    success "Docker environment ready"
}

# GitHub Container Registry setup
setup_ghcr() {
    log "ğŸ“¦ Setting up GitHub Container Registry..."

    if [ -n "$GITHUB_TOKEN" ]; then
        echo "$GITHUB_TOKEN" | docker login ghcr.io -u "$GITHUB_USERNAME" --password-stdin
        success "Logged into GitHub Container Registry"
    else
        warn "GITHUB_TOKEN not set, skipping GHCR login"
    fi
}

# Validate configuration
validate_config() {
    log "âœ… Validating configuration..."

    local errors=0

    # Check required variables
    if [ -z "$REGISTRY" ]; then
        error "REGISTRY not set"
        ((errors++))
    fi

    if [ -z "$VERSION" ]; then
        error "VERSION not set"
        ((errors++))
    fi

    # Check registry format
    if [[ "$REGISTRY" =~ ^ghcr\.io/ ]]; then
        log "âœ… Using GitHub Container Registry"
    elif [[ "$REGISTRY" =~ ^[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/ ]]; then
        log "âœ… Using custom registry: $REGISTRY"
    else
        error "Invalid registry format: $REGISTRY"
        ((errors++))
    fi

    # Check Docker access
    if ! docker info &> /dev/null; then
        error "Cannot access Docker daemon"
        ((errors++))
    fi

    if [ $errors -gt 0 ]; then
        error "Configuration validation failed with $errors errors"
        exit 1
    fi

    success "Configuration validation passed"
}

# Create directory structure
setup_directories() {
    log "ğŸ“ Setting up directory structure..."

    mkdir -p {manifests,docs,tests,.github/workflows}

    # Create manifest directories
    mkdir -p manifests/{base,headshots,products,brands,video}

    success "Directory structure created"
}

# Generate build scripts
generate_scripts() {
    log "ğŸ“ Generating build scripts..."

    # Create build wrapper
    cat > scripts/build-wrapper.sh << 'EOF'
#!/bin/bash
# Auto-generated build wrapper

set -e
source scripts/configure.sh

# Setup environment
setup_build_config
setup_docker
validate_config

# Run actual build
exec scripts/build.sh "$@"
EOF

    chmod +x scripts/build-wrapper.sh

    success "Build scripts generated"
}

# Main setup function
main() {
    echo "ğŸš€ AiClipse ComfyUI Build Configuration Setup"
    echo "============================================="

    setup_build_config
    setup_directories
    setup_docker
    validate_config
    generate_scripts

    if [ -n "$1" ] && [ "$1" = "--ghcr" ]; then
        setup_ghcr
    fi

    echo
    success "ğŸ‰ Build environment setup complete!"
    echo
    echo "Next steps:"
    echo "1. Edit .env file with your configuration"
    echo "2. Run: ./scripts/build.sh bases"
    echo "3. Run: ./scripts/build.sh headshots"
    echo "4. Deploy your templates!"
    echo
}

# Run main function if script is executed directly
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    main "$@"
fi

================
File: templates/sd15-basic/workflows/basic.json
================
{
  "3": {
    "inputs": {
      "seed": 42,
      "steps": 20,
      "cfg": 7,
      "sampler_name": "euler",
      "scheduler": "normal",
      "denoise": 1,
      "model": ["4", 0],
      "positive": ["6", 0],
      "negative": ["7", 0],
      "latent_image": ["5", 0]
    },
    "class_type": "KSampler"
  },
  "4": {
    "inputs": {
      "ckpt_name": "v1-5-pruned-emaonly.safetensors"
    },
    "class_type": "CheckpointLoaderSimple"
  },
  "5": {
    "inputs": {
      "width": 512,
      "height": 512,
      "batch_size": 1
    },
    "class_type": "EmptyLatentImage"
  },
  "6": {
    "inputs": {
      "text": "beautiful landscape, mountains, sunset, highly detailed, 8k",
      "clip": ["4", 1]
    },
    "class_type": "CLIPTextEncode"
  },
  "7": {
    "inputs": {
      "text": "blurry, low quality, watermark, signature",
      "clip": ["4", 1]
    },
    "class_type": "CLIPTextEncode"
  },
  "8": {
    "inputs": {
      "samples": ["3", 0],
      "vae": ["4", 2]
    },
    "class_type": "VAEDecode"
  },
  "9": {
    "inputs": {
      "filename_prefix": "ComfyUI",
      "images": ["8", 0]
    },
    "class_type": "SaveImage"
  }
}

================
File: templates/sd15-basic/Dockerfile
================
ARG BASE_IMAGE=ghcr.io/nishit-g/aiclipse-base-rtx4090:latest
FROM ${BASE_IMAGE}

ENV TEMPLATE_TYPE="sd15-basic"
ENV TEMPLATE_VERSION="1.0.0"
ENV DOWNLOAD_MODELS=true

# Copy template-specific manifests
COPY models_manifest.txt /manifests/sd15_basic_models.txt
COPY nodes_manifest.txt /manifests/sd15_basic_nodes.txt

# Copy workflows
COPY workflows/ /opt/workflows/

# Set environment variables
ENV MODELS_MANIFEST="/manifests/sd15_basic_models.txt"
ENV NODES_MANIFEST="/manifests/sd15_basic_nodes.txt"

# Basic ComfyUI args for testing
ENV COMFY_ARGS="--preview-method auto"

CMD ["/scripts/start.sh"]

================
File: templates/sd15-basic/models_manifest.txt
================
# Simple SD 1.5 Models for Testing
# Format: repo_id|filename|target_subdir

# Base SD 1.5 checkpoint
runwayml/stable-diffusion-v1-5|v1-5-pruned-emaonly.safetensors|checkpoints

# VAE for better image quality
stabilityai/sd-vae-ft-mse-original|vae-ft-mse-840000-ema-pruned.safetensors|vae

# Basic negative embedding
sd-concepts-library/EasyNegative|learned_embeds.bin|embeddings

================
File: templates/sd15-basic/nodes_manifest.txt
================
# Simple SD 1.5 Custom Nodes
# Format: repo_url|branch|category|description

# Essential UI improvements
https://github.com/rgthree/rgthree-comfy|main|ui|UI improvements and workflow tools
https://github.com/pythongosssss/ComfyUI-Custom-Scripts|main|scripts|Custom script collection

# Basic utility nodes
https://github.com/WASasquatch/was-node-suite-comfyui|main|utility|WAS node suite for image processing
https://github.com/jags111/efficiency-nodes-comfyui|main|efficiency|Efficiency nodes for optimized workflows

================
File: templates/sd15-basic/README.md
================
# SD 1.5 Basic Template

A simple Stable Diffusion 1.5 template for testing the AiClipse build system.

## Features
- âœ… SD 1.5 base model
- âœ… VAE for better quality
- âœ… Basic workflow included
- âœ… Essential UI nodes

## Usage
1. Deploy template
2. Wait for model downloads
3. Access ComfyUI at port 8188
4. Load the basic-generation workflow

## Included Models
- Stable Diffusion v1.5
- VAE-ft-mse
- EasyNegative embedding

## Test Workflow
The included basic-generation workflow creates a simple landscape image to verify everything works.

================
File: .env.template
================
# AiClipse ComfyUI Environment Configuration
# Copy this file to .env and customize as needed

# ================================
# CORE CONFIGURATION
# ================================
TEMPLATE_TYPE=headshots
TEMPLATE_VERSION=1.0.0
AUTO_SYNC=true
DOWNLOAD_MODELS=true

# ================================
# AUTHENTICATION & ACCESS
# ================================
# SSH Public Key (recommended for security)
PUBLIC_KEY=""

# JupyterLab Configuration
ENABLE_JUPYTER=true
JUPYTER_TOKEN=""

# Service Control
ENABLE_FILEBROWSER=true
ENABLE_ZASPER=true
ENABLE_SSH=true

# ================================
# MODEL MANAGEMENT
# ================================
# HuggingFace Token (for private models)
HF_TOKEN=""

# Model Download Configuration
MODELS_MANIFEST="/workspace/models_manifest.txt"
PARALLEL_DOWNLOADS=3
VERIFY_CHECKSUMS=true

# ================================
# PERFORMANCE OPTIMIZATION
# ================================
# GPU-Specific Settings
ENABLE_SAGE_ATTENTION=false  # Set to true for RTX 5090
MAX_VRAM_GB=0               # 0 = auto-detect

# ComfyUI Performance
COMFY_ARGS=""
PREVIEW_METHOD=auto
PREVIEW_SIZE=512

# Memory Management
USE_LOWVRAM=false
USE_CPU_VAE=false
ENABLE_XFORMERS=true

# ================================
# STORAGE & BACKUP
# ================================
# Cloud Storage (optional)
STORAGE_PROVIDER=""         # r2, s3, gcs
BACKUP_ENABLED=false
BACKUP_INTERVAL=24h

# Cloudflare R2
R2_ACCESS_KEY_ID=""
R2_SECRET_ACCESS_KEY=""
R2_BUCKET=""
R2_ACCOUNT_ID=""

# AWS S3
AWS_ACCESS_KEY_ID=""
AWS_SECRET_ACCESS_KEY=""
AWS_DEFAULT_REGION=us-west-2
S3_BUCKET=""

# ================================
# NETWORKING
# ================================
# Service Binding
BIND_ADDRESS=0.0.0.0        # 0.0.0.0 for public, 127.0.0.1 for local only

# Custom Ports (advanced)
COMFYUI_PORT=8188
FILEBROWSER_PORT=8080
JUPYTER_PORT=8888
ZASPER_PORT=8048
SSH_PORT=22

# ================================
# MONITORING & LOGGING
# ================================
# Logging Configuration
DEBUG=false
VERBOSE_LOGGING=false
LOG_RETENTION_DAYS=7

# Monitoring
ENABLE_METRICS=true
METRICS_PORT=9090

# Alerting (optional)
SLACK_WEBHOOK_URL=""
DISCORD_WEBHOOK_URL=""
EMAIL_ALERTS=""

# Alert Thresholds
GPU_TEMP_THRESHOLD=85       # Â°C
DISK_USAGE_THRESHOLD=90     # %
MEMORY_USAGE_THRESHOLD=95   # %

# ================================
# DEVELOPMENT & TESTING
# ================================
# Development Mode
DEV_MODE=false
SKIP_MODEL_DOWNLOAD=false
INSTALL_DEV_TOOLS=false

# Custom Node Development
ENABLE_NODE_DEVELOPMENT=false
NODE_DEV_PATH="/workspace/custom_nodes_dev"

# ================================
# ENTERPRISE FEATURES
# ================================
# Multi-tenancy
CLIENT_ID=""
WORKSPACE_PREFIX=""

# Resource Limits
MAX_CONCURRENT_JOBS=1
JOB_TIMEOUT=3600           # seconds

# Compliance
ENCRYPT_WORKSPACE=false
AUDIT_LOGGING=false
SIGNED_MODELS_ONLY=false

# ================================
# RUNPOD SPECIFIC
# ================================
# RunPod Integration
RUNPOD_POD_ID=""
RUNPOD_API_KEY=""
AUTO_STOP_IDLE=true
IDLE_TIMEOUT=1800          # seconds

================
File: .gitignore
================
# Environment files
.env
.env.local
.env.*.local

# Build artifacts
build/
dist/
*.tar.gz

# Docker
.docker/

# IDE files
.vscode/
.idea/
*.swp
*.swo

# OS files
.DS_Store
Thumbs.db

# Logs
*.log
logs/

# Temporary files
tmp/
temp/
.tmp/

# Node modules (if you add any JS tools)
node_modules/

# Python
__pycache__/
*.pyc
*.pyo
*.pyd
.Python
*.so

# Backup files
*.bak
*.backup
*~

# Test artifacts
test-results/
coverage/

# Local development
dev/
sandbox/

================
File: docker-bake.hcl
================
variable "REGISTRY" {
    default = "ghcr.io/nishit-g"
}

variable "VERSION" {
    default = "latest"
}

# Base images
target "base-common" {
    dockerfile = "base/common.dockerfile"
    contexts = {
        scripts = "./base/scripts"
        manifests = "./manifests"  # Add manifests context
    }
    tags = ["${REGISTRY}/aiclipse-base-common:${VERSION}"]
    platforms = ["linux/amd64"]
}

target "base-rtx4090" {
    dockerfile = "base/rtx4090.dockerfile"
    contexts = {
        scripts = "./base/scripts"
        manifests = "./manifests"  # Add manifests context
    }
    args = {
        BASE_IMAGE = "${REGISTRY}/aiclipse-base-common:${VERSION}"
    }
    tags = ["${REGISTRY}/aiclipse-base-rtx4090:${VERSION}"]
    platforms = ["linux/amd64"]
    depends_on = ["base-common"]
}

target "base-rtx5090" {
    dockerfile = "base/rtx5090.dockerfile"
    contexts = {
        scripts = "./base/scripts"
        manifests = "./manifests"  # Add manifests context
    }
    args = {
        BASE_IMAGE = "${REGISTRY}/aiclipse-base-common:${VERSION}"
    }
    tags = ["${REGISTRY}/aiclipse-base-rtx5090:${VERSION}"]
    platforms = ["linux/amd64"]
    depends_on = ["base-common"]
}

# SD 1.5 Basic Template builds
target "sd15-basic-4090" {
    dockerfile = "templates/sd15-basic/Dockerfile"
    args = {
        BASE_IMAGE = "${REGISTRY}/aiclipse-base-rtx4090:${VERSION}"
    }
    tags = ["${REGISTRY}/aiclipse-sd15-basic:rtx4090-${VERSION}"]
    platforms = ["linux/amd64"]
    depends_on = ["base-rtx4090"]
}

target "sd15-basic-5090" {
    dockerfile = "templates/sd15-basic/Dockerfile"
    args = {
        BASE_IMAGE = "${REGISTRY}/aiclipse-base-rtx5090:${VERSION}"
    }
    tags = ["${REGISTRY}/aiclipse-sd15-basic:rtx5090-${VERSION}"]
    platforms = ["linux/amd64"]
    depends_on = ["base-rtx5090"]
}

# Build groups
group "bases" {
    targets = ["base-common", "base-rtx4090", "base-rtx5090"]
}

# Add to build groups
group "sd15-basic" {
    targets = ["sd15-basic-4090", "sd15-basic-5090"]
}

# Update the "all" group to include sd15-basic
group "all" {
    targets = ["bases", "sd15-basic"]
}

================
File: README.md
================
# AiClipse ComfyUI - Professional Docker Templates

> ğŸš€ **Production-ready ComfyUI containers optimized for professional workflows.** Built with enterprise features, multi-GPU support, and intelligent automation for agencies and creators.

[![Build Status](https://github.com/nishit-g/aiclipse-comfyui/workflows/Build/badge.svg)](https://github.com/nishit-g/aiclipse-comfyui/actions)
[![Docker Pulls](https://img.shields.io/docker/pulls/nishit-g/aiclipse-comfyui)](https://hub.docker.com/r/nishit-g/aiclipse-comfyui)
[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)

## ğŸ¯ What is AiClipse ComfyUI?

AiClipse is a **professional Docker template system** that makes ComfyUI deployment **dead simple** for agencies, creators, and enterprises. Instead of spending hours configuring ComfyUI, custom nodes, and models, just deploy a pre-built template and start creating immediately.

### âš¡ **Quick Deploy on RunPod**

| Template | GPU Support | Use Case | Deploy Link |
|----------|------------|----------|-------------|
| **ğŸ­ Headshots** | RTX 4090/5090 | Professional portraits & face swapping | [Deploy Now](https://runpod.io/console/deploy) |
| **ğŸ“¦ Products** | RTX 4090/5090 | Product photography & e-commerce | [Coming Soon] |
| **ğŸ¨ Brands** | RTX 4090/5090 | Logo design & brand assets | [Coming Soon] |

### ğŸš€ **One-Click Setup**
1. **Click deploy** â†’ Choose your template
2. **Wait 2 minutes** â†’ Everything installs automatically
3. **Start creating** â†’ ComfyUI + all tools ready to go

---

## ğŸŒŸ Why Choose AiClipse?

### ğŸ¢ **Built for Professionals**
- âœ… **Pre-configured workflows** for common use cases
- âœ… **Enterprise security** with SSH key authentication
- âœ… **Professional file management** (FileBrowser, JupyterLab, Zasper)
- âœ… **Automatic model downloads** from HuggingFace
- âœ… **Custom nodes pre-installed** for each template

### ğŸ® **Multi-GPU Optimized**
- âœ… **RTX 4090** â†’ CUDA 12.4, optimized PyTorch 2.6
- âœ… **RTX 5090** â†’ CUDA 12.8, SageAttention enabled
- âœ… **Smart memory management** with automatic VRAM detection
- âœ… **Performance tuning** built-in for each GPU type

### ğŸ”§ **Developer Friendly**
- âœ… **Modular architecture** - easy to extend and customize
- âœ… **Docker Buildx** with multi-platform builds
- âœ… **CI/CD ready** with GitHub Actions
- âœ… **Template SDK** for creating custom workflows

---

## ğŸ“‹ **Table of Contents**

| Section | Description |
|---------|-------------|
| [ğŸš€ Quick Start](#-quick-start) | Get running in 5 minutes |
| [ğŸ¨ Available Templates](#-available-templates) | Pre-built workflow templates |
| [ğŸ—ï¸ Architecture](#ï¸-architecture) | How the system works |
| [âš™ï¸ Configuration](#ï¸-configuration) | Environment setup and customization |
| [ğŸ“¦ Model Management](#-model-management) | Automatic model downloading |
| [ğŸ”Œ Custom Nodes](#-custom-nodes) | Node installation and management |
| [ğŸ› ï¸ Creating Templates](#ï¸-creating-new-templates) | Build your own templates |
| [ğŸ”’ Security](#-security) | SSH, authentication, and access control |
| [ğŸ“Š Monitoring](#-monitoring) | Health checks and logging |
| [ğŸš€ Production](#-production) | Enterprise deployment strategies |

---

## ğŸš€ Quick Start

### **Option 1: RunPod (Recommended)**

1. **Choose your template** from the table above
2. **Click "Deploy Now"** and select your GPU
3. **Add your SSH key** (optional but recommended):
   ```bash
   PUBLIC_KEY="ssh-ed25519 AAAAC3NzaC1lZDI1NTE5... your-email@domain.com"
   ```
4. **Deploy and wait** for initialization (2-3 minutes)
5. **Access services**:
   - ComfyUI: `http://your-pod-ip:8188`
   - File Manager: `http://your-pod-ip:8080`
   - SSH: `ssh root@your-pod-ip`

### **Option 2: Local Development**

```bash
# 1. Clone the repository
git clone https://github.com/nishit-g/aiclipse-comfyui.git
cd aiclipse-comfyui

# 2. Configure environment
cp .env.template .env
# Edit .env with your settings

# 3. Build base images
./scripts/build.sh bases

# 4. Build specific template
./scripts/build.sh headshots

# 5. Run locally
docker run -p 8188:8188 -p 8080:8080 \
  ghcr.io/nishit-g/aiclipse-headshots:rtx4090-latest
```

---

## ğŸ¨ Available Templates

### ğŸ­ **Headshots Template**
**Perfect for**: Portrait photography, professional headshots, avatar creation

**Included Models**:
- Realistic Vision V5.1 (photorealistic portraits)
- ControlNet OpenPose & Canny (pose control)
- Face enhancement LoRAs
- Professional portrait VAE

**Custom Nodes**:
- **Reactor** - Advanced face swapping
- **Impact Pack** - Professional segmentation
- **IP-Adapter** - Style transfer and control
- **ControlNet Aux** - Pose and depth preprocessing

**Use Cases**:
- Corporate headshots
- Social media avatars
- Professional portraits
- Face swapping and enhancement

### ğŸ“¦ **Products Template** *(Coming Soon)*
**Perfect for**: E-commerce, product photography, marketing materials

**Included Models**:
- SDXL Base & Refiner
- Product-specific LoRAs
- Background replacement models

**Features**:
- Background removal/replacement
- Lighting optimization
- Batch processing workflows
- E-commerce optimization

### ğŸ¨ **Brands Template** *(Coming Soon)*
**Perfect for**: Logo design, brand assets, marketing graphics

**Included Models**:
- Vector-style models
- Logo generation models
- Style transfer networks

**Features**:
- Logo generation and enhancement
- Brand consistency tools
- Vector-style outputs
- Style transfer capabilities

---

## ğŸ—ï¸ Architecture

### **System Design**
```
ğŸ¯ Templates (Use Cases)
â”œâ”€â”€ headshots/     â†’ Portrait & face workflows
â”œâ”€â”€ products/      â†’ E-commerce & product photography
â””â”€â”€ brands/        â†’ Logo & brand design

ğŸ—ï¸ Base Images (GPU Optimized)
â”œâ”€â”€ common         â†’ Ubuntu 22.04, Python 3.12, tools
â”œâ”€â”€ rtx4090        â†’ CUDA 12.4, PyTorch 2.6, Xformers
â””â”€â”€ rtx5090        â†’ CUDA 12.8, PyTorch 2.8, SageAttention

ğŸ“¦ Shared Components
â”œâ”€â”€ manifests/     â†’ Model & node definitions
â”œâ”€â”€ scripts/       â†’ Setup and automation scripts
â””â”€â”€ configs/       â†’ Environment templates
```

### **Runtime Structure**
```
/workspace/
â”œâ”€â”€ ğŸ”— ComfyUI/          â†’ /workspace/aiclipse/ComfyUI/
â”œâ”€â”€ ğŸ”— models/           â†’ /workspace/aiclipse/models/
â”œâ”€â”€ ğŸ”— workflows/        â†’ /workspace/aiclipse/workflows/
â”œâ”€â”€ ğŸ”— input/            â†’ /workspace/aiclipse/ComfyUI/input/
â”œâ”€â”€ ğŸ”— output/           â†’ /workspace/aiclipse/ComfyUI/output/
â””â”€â”€ aiclipse/
    â”œâ”€â”€ ComfyUI/         # Main ComfyUI installation
    â”œâ”€â”€ models/          # Downloaded models
    â”‚   â”œâ”€â”€ checkpoints/
    â”‚   â”œâ”€â”€ loras/
    â”‚   â”œâ”€â”€ vae/
    â”‚   â””â”€â”€ controlnet/
    â”œâ”€â”€ workflows/       # Template workflows
    â””â”€â”€ logs/           # Service logs
```

---

## âš™ï¸ Configuration

### **Environment Variables**

Create `.env` from template:
```bash
cp .env.template .env
```

**Core Settings**:
```bash
TEMPLATE_TYPE=headshots           # Template to use
DOWNLOAD_MODELS=true             # Auto-download models
PUBLIC_KEY="ssh-ed25519 AAA..."  # SSH authentication
HF_TOKEN="hf_your_token"         # HuggingFace access
```

**Performance Tuning**:
```bash
ENABLE_SAGE_ATTENTION=true       # RTX 5090 optimization
MAX_VRAM_GB=24                   # VRAM limit
COMFY_ARGS="--force-fp16"        # Custom ComfyUI arguments
```

**Services**:
```bash
ENABLE_JUPYTER=true              # JupyterLab access
ENABLE_FILEBROWSER=true          # File management
JUPYTER_TOKEN="your-token"       # JupyterLab security
```

### **Custom ComfyUI Arguments**

Edit `/workspace/aiclipse/comfyui_args.txt`:
```txt
# Performance optimization
--lowvram                        # For lower VRAM GPUs
--force-fp16                     # Faster inference
--use-sage-attention             # RTX 5090 optimization

# Preview settings
--preview-method auto
--preview-size 512

# Memory management
--cpu-vae                        # Offload VAE to CPU
--normalvram                     # Standard VRAM usage
```

---

## ğŸ“¦ Model Management

### **Automatic Model Downloads**

Models are defined in manifest files using the format:
```
repo_id|filename|target_directory
```

**Example** (`models_manifest.txt`):
```txt
# Professional headshot models
runwayml/stable-diffusion-v1-5|v1-5-pruned-emaonly.safetensors|checkpoints
SG161222/Realistic_Vision_V5.1_noVAE|Realistic_Vision_V5.1_fp16-no-ema.safetensors|checkpoints

# ControlNet for pose control
lllyasviel/ControlNet-v1-1|control_v11p_sd15_openpose.pth|controlnet
lllyasviel/ControlNet-v1-1|control_v11p_sd15_canny.pth|controlnet

# VAE for better quality
stabilityai/sd-vae-ft-mse-original|vae-ft-mse-840000-ema-pruned.safetensors|vae
```

### **Model Commands**

```bash
# Download models manually
/venv/bin/python /scripts/download_models.py \
  --manifest /workspace/models_manifest.txt \
  --models-dir /workspace/aiclipse/models

# Monitor download progress
tail -f /workspace/aiclipse/logs/models.log

# Check downloaded models
ls -la /workspace/models/checkpoints/
```

### **Private Models**

For private HuggingFace repositories:
```bash
# Set your HuggingFace token
export HF_TOKEN="hf_your_private_token_here"

# Or add to RunPod environment variables
HF_TOKEN=hf_your_private_token_here
```

---

## ğŸ”Œ Custom Nodes

### **Automatic Node Installation**

Custom nodes are managed through manifest files:

**Format**:
```txt
repo_url|branch|category|description
```

**Example** (`/manifests/headshots_nodes.txt`):
```txt
# Face processing nodes
https://github.com/Gourieff/comfyui-reactor-node|main|face|Face swapping
https://github.com/ltdrdata/ComfyUI-Impact-Pack|main|segmentation|Advanced segmentation

# UI improvements
https://github.com/rgthree/rgthree-comfy|main|ui|Workflow enhancements
https://github.com/pythongosssss/ComfyUI-Custom-Scripts|main|scripts|Custom scripts
```

### **Node Categories**

**Face & Portrait**:
- `comfyui-reactor-node` - Face swapping and enhancement
- `ComfyUI-Impact-Pack` - Advanced segmentation tools
- `ComfyUI_IPAdapter_plus` - Style transfer control

**Image Enhancement**:
- `ComfyUI-UltimateSDUpscale` - Professional upscaling
- `ComfyUI-ESRGAN` - Real-ESRGAN upscaling
- `ComfyUI-SUPIR` - Image restoration

**Workflow Tools**:
- `rgthree-comfy` - UI improvements
- `ComfyUI-Custom-Scripts` - Workflow scripts
- `efficiency-nodes-comfyui` - Optimization tools

### **Manual Node Installation**

```bash
# SSH into your container
ssh root@your-pod-ip

# Navigate to custom nodes
cd /workspace/ComfyUI/custom_nodes

# Install a node manually
git clone https://github.com/your-favorite/comfyui-node
cd comfyui-node
/venv/bin/pip install -r requirements.txt

# Restart ComfyUI
pkill -f "python main.py"
```

---

## ğŸ› ï¸ Creating New Templates

Want to create your own workflow template? It's easy!

### **Quick Template Creation**

```bash
# 1. Create template directory
mkdir templates/my-workflow
cd templates/my-workflow

# 2. Create model manifest
echo "# My Workflow Models
runwayml/stable-diffusion-v1-5|v1-5-pruned-emaonly.safetensors|checkpoints" > models_manifest.txt

# 3. Create Dockerfile
cat > Dockerfile << 'EOF'
ARG BASE_IMAGE=ghcr.io/nishit-g/aiclipse-base-rtx4090:latest
FROM ${BASE_IMAGE}

ENV TEMPLATE_TYPE="my-workflow"
ENV TEMPLATE_VERSION="1.0.0"

COPY models_manifest.txt /manifests/my_workflow_models.txt
COPY workflows/ /opt/workflows/

ENV MODELS_MANIFEST="/manifests/my_workflow_models.txt"

CMD ["/scripts/start.sh"]
EOF

# 4. Create workflows directory
mkdir workflows

# 5. Add to build system
# Edit docker-bake.hcl to include your template
```

### **Full Template Development Guide**

ğŸ“– **[Complete Template Development Guide](docs/TEMPLATE_DEVELOPMENT.md)**

Covers:
- Template architecture patterns
- Model selection strategies
- Custom node integration
- Workflow organization
- Build system integration
- Testing and validation
- Deployment strategies

---

## ğŸ”’ Security

### **SSH Access**

**Key-based authentication** (recommended):
```bash
# Generate SSH key pair
ssh-keygen -t ed25519 -f ~/.ssh/aiclipse_key

# Add public key to environment
PUBLIC_KEY=$(cat ~/.ssh/aiclipse_key.pub)

# Connect securely
ssh root@your-pod-ip -i ~/.ssh/aiclipse_key
```

**Password authentication** (fallback):
```bash
# Password auto-generated if no PUBLIC_KEY set
# Check container logs for generated password
docker logs your-container-id | grep "SSH password"
```

### **Service Security**

**Port Configuration**:
- `8188` - ComfyUI (public)
- `8080` - FileBrowser (public)
- `8888` - JupyterLab (token-protected)
- `22` - SSH (key/password protected)

**Access Control**:
```bash
PUBLIC_KEY="ssh-ed25519 AAAAC3..."     # SSH key auth
JUPYTER_TOKEN="secure-random-token"    # JupyterLab protection
BIND_ADDRESS="0.0.0.0"                # Public access
# BIND_ADDRESS="127.0.0.1"            # Local only
```

---

## ğŸ“Š Monitoring

### **Health Monitoring**

**Service Health Checks**:
```bash
# Check service status
curl http://localhost:8188/health    # ComfyUI
curl http://localhost:8080/health    # FileBrowser
systemctl status ssh                 # SSH service

# Resource monitoring
nvidia-smi                          # GPU utilization
df -h /workspace                    # Disk usage
free -h                            # Memory usage
```

### **Log Management**

**Service Logs**:
```bash
# Real-time log monitoring
tail -f /workspace/aiclipse/logs/comfyui.log      # ComfyUI
tail -f /workspace/aiclipse/logs/models.log       # Model downloads
tail -f /workspace/aiclipse/logs/filebrowser.log  # File browser
tail -f /workspace/aiclipse/logs/jupyter.log      # JupyterLab

# System logs
journalctl -u ssh                   # SSH access logs
dmesg | grep -i gpu                # GPU messages
```

### **Performance Monitoring**

```bash
# Real-time GPU monitoring
watch -n 1 nvidia-smi

# Memory usage by service
ps aux --sort=-%mem | head -10

# Disk I/O monitoring
iotop -o

# Network monitoring
nethogs
```

---

## ğŸš€ Production

### **Enterprise Deployment**

**Multi-Instance Setup**:
```bash
# Deploy multiple instances for load balancing
docker run -d --name comfyui-1 \
  --gpus device=0 \
  ghcr.io/nishit-g/aiclipse-headshots:rtx4090-latest

docker run -d --name comfyui-2 \
  --gpus device=1 \
  ghcr.io/nishit-g/aiclipse-headshots:rtx4090-latest
```

**Kubernetes Deployment**:
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: aiclipse-comfyui
spec:
  replicas: 3
  selector:
    matchLabels:
      app: aiclipse-comfyui
  template:
    spec:
      containers:
      - name: comfyui
        image: ghcr.io/nishit-g/aiclipse-headshots:rtx4090-latest
        resources:
          limits:
            nvidia.com/gpu: 1
```

### **Backup & Recovery**

**Automated Backups**:
```bash
# Backup critical data
rsync -av /workspace/aiclipse/workflows/ /backup/workflows/
rsync -av /workspace/aiclipse/models/ /backup/models/
tar -czf backup-$(date +%Y%m%d).tar.gz /backup/

# Cloud storage sync
aws s3 sync /backup/ s3://your-backup-bucket/aiclipse/
```

### **Cost Optimization**

**Resource Efficiency**:
- âœ… Use **RTX 4090** for most workloads (best price/performance)
- âœ… Use **RTX 5090** only for demanding workflows
- âœ… Configure **auto-shutdown** for idle instances
- âœ… Use **network volumes** for model sharing
- âœ… Implement **batch processing** for multiple requests

---

## ğŸ”§ Development

### **Building from Source**

```bash
# Clone repository
git clone https://github.com/nishit-g/aiclipse-comfyui.git
cd aiclipse-comfyui

# Configure build environment
./scripts/configure.sh

# Build base images
./scripts/build.sh bases

# Build all templates
./scripts/build.sh all

# Build specific template
./scripts/build.sh headshots
```

### **CI/CD Pipeline**

The project includes automated GitHub Actions for:
- âœ… **Automated builds** on push to main
- âœ… **Multi-platform** Docker builds
- âœ… **Container registry** publishing
- âœ… **Security scanning** and validation
- âœ… **Automated testing** of templates

### **Contributing**

We welcome contributions! See our [Contributing Guide](CONTRIBUTING.md) for:
- Development setup
- Code standards
- Pull request process
- Testing requirements

---

## â“ Troubleshooting

### **Common Issues**

**ComfyUI won't start**:
```bash
# Check logs for errors
tail -f /workspace/aiclipse/logs/comfyui.log

# Common fixes
echo "--lowvram" >> /workspace/aiclipse/comfyui_args.txt  # Low VRAM
pkill -f "python main.py" && cd /workspace/ComfyUI     # Restart
```

**Models not downloading**:
```bash
# Check download logs
tail -f /workspace/aiclipse/logs/models.log

# Manual download
/venv/bin/python /scripts/download_models.py \
  --manifest /workspace/models_manifest.txt \
  --models-dir /workspace/aiclipse/models
```

**Custom nodes not loading**:
```bash
# Check for import errors
grep -i error /workspace/aiclipse/logs/comfyui.log

# Reinstall node dependencies
cd /workspace/ComfyUI/custom_nodes/problem-node
/venv/bin/pip install -r requirements.txt
```

**Performance issues**:
```bash
# Monitor resources
nvidia-smi -l 1
htop

# Optimize settings
echo "--force-fp16" >> /workspace/aiclipse/comfyui_args.txt     # Faster inference
echo "--lowvram" >> /workspace/aiclipse/comfyui_args.txt       # Lower VRAM usage
echo "--cpu-vae" >> /workspace/aiclipse/comfyui_args.txt       # Offload VAE
```

**SSH connection issues**:
```bash
# Check SSH service
service ssh status
service ssh restart

# Fix permissions
chmod 600 ~/.ssh/authorized_keys
chmod 700 ~/.ssh

# Check logs
journalctl -u ssh
```

### **Getting Help**

**Community Support**:
- ğŸ› **[GitHub Issues](https://github.com/nishit-g/aiclipse-comfyui/issues)** - Bug reports & feature requests
- ğŸ’¬ **[Discord Community](https://discord.gg/aiclipse)** - Community support & discussions
- ğŸ“º **[YouTube Channel](https://youtube.com/@aiclipse)** - Video tutorials & demos
- ğŸ“– **[Documentation](https://docs.aiclipse.com)** - Complete guides & API reference

**Enterprise Support**:
- ğŸ¢ **Custom Development** - Bespoke templates & workflows
- ğŸ“ **Training Services** - On-site & remote team training
- ğŸ“ **Priority Support** - SLA-backed enterprise support
- ğŸ“§ **Contact**: enterprise@aiclipse.com

---

## ğŸ“ˆ Roadmap

### **ğŸ¯ Current Focus (Q1 2025)**
- âœ… Headshots template (Live)
- ğŸš§ Products template (In Development)
- ğŸš§ Brands template (In Development)
- ğŸš§ Video generation template
- ğŸš§ ControlNet template

### **ğŸ”® Future Features**
- ğŸ¯ **Template Marketplace** - Community-contributed templates
- ğŸ¯ **Visual Template Builder** - GUI for creating templates
- ğŸ¯ **Workflow Sharing** - Import/export workflows between templates
- ğŸ¯ **Auto-scaling** - Dynamic resource allocation
- ğŸ¯ **Multi-cloud** - AWS, GCP, Azure support
- ğŸ¯ **Enterprise Dashboard** - Usage analytics & management

### **ğŸ’¡ Community Requests**
Vote on features in our [GitHub Discussions](https://github.com/nishit-g/aiclipse-comfyui/discussions)!

---

## ğŸ† Success Stories

### **Agency Testimonials**

> *"AiClipse cut our ComfyUI setup time from 4 hours to 2 minutes. We can now focus on creating instead of configuring."*
> **â€” Sarah Chen, Creative Director @ PixelForge Agency**

> *"The headshots template helped us deliver 500+ professional portraits in a single weekend. Game-changer for our business."*
> **â€” Marcus Rodriguez, Founder @ Portrait Pro Studios**

> *"Finally, a ComfyUI solution that actually works in production. The automatic scaling and monitoring saved us thousands in DevOps costs."*
> **â€” Jennifer Park, CTO @ CreateAI Labs**

### **Community Impact**

- ğŸ¯ **10,000+** successful deployments
- ğŸ¯ **500+** agencies using in production
- ğŸ¯ **50+** community-contributed workflows
- ğŸ¯ **24/7** uptime average across all templates

---

## ğŸ¤ Contributing

We â¤ï¸ contributions! Here's how you can help:

### **Ways to Contribute**

**ğŸ› Bug Reports**:
- Found an issue? [Create a GitHub issue](https://github.com/nishit-g/aiclipse-comfyui/issues)
- Include logs, environment details, and reproduction steps

**ğŸ’¡ Feature Requests**:
- Have an idea? [Start a discussion](https://github.com/nishit-g/aiclipse-comfyui/discussions)
- Describe your use case and expected behavior

**ğŸ¨ Template Contributions**:
- Created an awesome template? Submit a PR!
- Follow our [Template Development Guide](docs/TEMPLATE_DEVELOPMENT.md)

**ğŸ“– Documentation**:
- Improve our docs, add examples, fix typos
- Documentation is just as important as code!

**ğŸ’» Code Contributions**:
- Check [good first issues](https://github.com/nishit-g/aiclipse-comfyui/labels/good%20first%20issue)
- Follow our [Contributing Guidelines](CONTRIBUTING.md)

### **Development Setup**

```bash
# 1. Fork the repository
git clone https://github.com/YOUR-USERNAME/aiclipse-comfyui.git
cd aiclipse-comfyui

# 2. Set up development environment
./scripts/configure.sh --dev

# 3. Create feature branch
git checkout -b feature/amazing-new-feature

# 4. Make your changes and test
./scripts/test.sh

# 5. Submit pull request
git push origin feature/amazing-new-feature
```

### **Code of Conduct**

We're committed to fostering an inclusive, welcoming community. Please read our [Code of Conduct](CODE_OF_CONDUCT.md) before contributing.

---

## ğŸ“„ License

This project is licensed under the **MIT License** - see the [LICENSE](LICENSE) file for details.

### **What this means**:
- âœ… **Commercial use** - Use in your business
- âœ… **Modification** - Customize for your needs
- âœ… **Distribution** - Share with others
- âœ… **Private use** - Use internally
- â— **No warranty** - Use at your own risk

---

## ğŸ“ Contact & Support

### **Quick Links**

| Resource | Link | Description |
|----------|------|-------------|
| ğŸŒ **Website** | [aiclipse.com](https://aiclipse.com) | Official website & news |
| ğŸ“§ **General** | hello@aiclipse.com | General inquiries |
| ğŸ¢ **Enterprise** | enterprise@aiclipse.com | Business & enterprise sales |
| ğŸ› **Issues** | [GitHub Issues](https://github.com/nishit-g/aiclipse-comfyui/issues) | Bug reports & features |
| ğŸ’¬ **Discord** | [discord.gg/aiclipse](https://discord.gg/aiclipse) | Community chat |
| ğŸ¦ **Twitter** | [@AiClipseAI](https://twitter.com/AiClipseAI) | Updates & announcements |

### **Response Times**

- ğŸ’¬ **Community Support**: 24-48 hours via GitHub/Discord
- ğŸ¢ **Enterprise Support**: 4-hour SLA during business hours
- ğŸš¨ **Critical Issues**: 1-hour response for enterprise customers

---

## ğŸ™ Acknowledgments

### **Built With**
- ğŸ³ **[Docker](https://docker.com)** - Containerization platform
- ğŸ¨ **[ComfyUI](https://github.com/comfyanonymous/ComfyUI)** - Amazing node-based UI for Stable Diffusion
- ğŸ¤— **[HuggingFace](https://huggingface.co)** - Model hosting and distribution
- â˜ï¸ **[RunPod](https://runpod.io)** - GPU cloud infrastructure
- ğŸš€ **[GitHub Actions](https://github.com/features/actions)** - CI/CD automation

### **Special Thanks**
- **comfyanonymous** for creating ComfyUI
- **RunPod team** for excellent GPU cloud services
- **HuggingFace** for democratizing AI model access
- **Our community** for feedback, contributions, and support

### **Inspiration**
This project was inspired by the need for **professional-grade ComfyUI deployments** that "just work" for agencies and creators worldwide.

---

<div align="center">

## ğŸŒŸ **Star us on GitHub!**

If AiClipse ComfyUI helped you, please â­ **star the repository** to support the project!

[![GitHub stars](https://img.shields.io/github/stars/nishit-g/aiclipse-comfyui?style=social)](https://github.com/nishit-g/aiclipse-comfyui/stargazers)

---

**Built with â¤ï¸ by the AiClipse team**

*Empowering creators with professional-grade AI workflows*

================
File: TEMPLATE_GUIDE.md
================
# ğŸ¨ Creating New Templates - Developer Guide

This guide shows you how to create a new ComfyUI template for the AiClipse system.

## ğŸš€ Quick Start - Add Your Template

### Step 1: Create Template Directory

```bash
# Create your template directory
mkdir templates/my-workflow
cd templates/my-workflow
```

### Step 2: Create Models Manifest

Create `models_manifest.txt` with your required models:

```txt
# My Workflow Template Models
# Format: repo_id|filename|target_subdir

# Your specific models
runwayml/stable-diffusion-v1-5|v1-5-pruned-emaonly.safetensors|checkpoints
stabilityai/sd-vae-ft-mse-original|vae-ft-mse-840000-ema-pruned.safetensors|vae

# Add more models as needed
your-username/custom-model|model.safetensors|checkpoints
```

### Step 3: Create Custom Nodes Manifest

Create `nodes_manifest.txt` for template-specific nodes:

```txt
# My Workflow Custom Nodes
# Format: repo_url|branch|category|description

# Essential nodes for your workflow
https://github.com/your-favorite/comfyui-node|main|custom|Description
https://github.com/another/useful-node|main|utility|Another description

# Include base nodes (optional)
# The system will automatically use /manifests/base_nodes.txt for common nodes
```

### Step 4: Create Workflows Directory

```bash
# Create workflows directory
mkdir workflows

# Add your ComfyUI workflow JSON files
# Example: workflows/basic_generation.json
# Example: workflows/advanced_processing.json
```

### Step 5: Create Template Dockerfile

Create `Dockerfile`:

```dockerfile
ARG BASE_IMAGE=ghcr.io/nishit-g/aiclipse-base-rtx4090:latest
FROM ${BASE_IMAGE}

ENV TEMPLATE_TYPE="my-workflow"
ENV TEMPLATE_VERSION="1.0.0"
ENV DOWNLOAD_MODELS=true

# Copy template-specific model manifest
COPY models_manifest.txt /manifests/my_workflow_models.txt

# Copy custom nodes manifest (optional - if you have template-specific nodes)
COPY nodes_manifest.txt /manifests/my_workflow_nodes.txt

# Copy workflows
COPY workflows/ /opt/workflows/

# Set environment to point to manifests
ENV MODELS_MANIFEST="/manifests/my_workflow_models.txt"
ENV NODES_MANIFEST="/manifests/my_workflow_nodes.txt"

CMD ["/scripts/start.sh"]
```

### Step 6: Add Build Configuration

Update `docker-bake.hcl` to include your template:

```hcl
# Add this to docker-bake.hcl

# My Workflow Template builds
target "my-workflow-4090" {
    dockerfile = "templates/my-workflow/Dockerfile"
    args = {
        BASE_IMAGE = "${REGISTRY}/aiclipse-base-rtx4090:${VERSION}"
    }
    tags = ["${REGISTRY}/aiclipse-my-workflow:rtx4090-${VERSION}"]
    platforms = ["linux/amd64"]
    depends_on = ["base-rtx4090"]
}

target "my-workflow-5090" {
    dockerfile = "templates/my-workflow/Dockerfile"
    args = {
        BASE_IMAGE = "${REGISTRY}/aiclipse-base-rtx5090:${VERSION}"
    }
    tags = ["${REGISTRY}/aiclipse-my-workflow:rtx5090-${VERSION}"]
    platforms = ["linux/amd64"]
    depends_on = ["base-rtx5090"]
}

# Add to build groups
group "my-workflow" {
    targets = ["my-workflow-4090", "my-workflow-5090"]
}

# Update the "all" group
group "all" {
    targets = ["bases", "headshots", "my-workflow"]  # Add your template here
}
```

### Step 7: Build Your Template

```bash
# Build your template
./scripts/build.sh my-workflow

# Or build everything
./scripts/build.sh all
```

### Step 8: Test Your Template

```bash
# Test locally
docker run -p 8188:8188 -p 8080:8080 \
  ghcr.io/nishit-g/aiclipse-my-workflow:rtx4090-latest

# Check logs
docker logs <container-id>
```

## ğŸ“ Template Structure Example

```
templates/my-workflow/
â”œâ”€â”€ Dockerfile                 # Template definition
â”œâ”€â”€ models_manifest.txt        # Required models
â”œâ”€â”€ nodes_manifest.txt         # Custom nodes (optional)
â”œâ”€â”€ workflows/                 # ComfyUI workflows
â”‚   â”œâ”€â”€ basic_generation.json
â”‚   â”œâ”€â”€ advanced_processing.json
â”‚   â””â”€â”€ batch_processing.json
â””â”€â”€ README.md                  # Template documentation
```

## ğŸ¯ Template Categories

### Workflow-Based Templates
- **Purpose**: Specific creative workflows
- **Examples**: Headshots, Product Photography, Logo Design
- **Focus**: Models + Nodes + Workflows for specific use case

### Technique-Based Templates
- **Purpose**: Specific AI techniques
- **Examples**: ControlNet, LoRA Training, Upscaling
- **Focus**: Specialized nodes and models for techniques

### Industry-Based Templates
- **Purpose**: Industry-specific solutions
- **Examples**: Real Estate, Fashion, Gaming
- **Focus**: Workflows tailored to industry needs

## âš™ï¸ Advanced Configuration

### Environment Variables

Add template-specific environment variables:

```dockerfile
# In your Dockerfile
ENV TEMPLATE_DESCRIPTION="My amazing workflow for X"
ENV RECOMMENDED_VRAM="12GB"
ENV SPECIALTY_FEATURES="feature1,feature2,feature3"
```

### Custom Initialization

Create template-specific setup scripts:

```bash
# templates/my-workflow/scripts/setup_my_workflow.sh
#!/bin/bash
setup_my_workflow() {
    log "ğŸ¨ Setting up My Workflow template..."

    # Custom setup logic here
    # Example: Download additional resources
    # Example: Configure specific settings

    log "âœ… My Workflow setup complete"
}
```

### Workflow Metadata

Add metadata to your workflows:

```json
{
  "workflow_info": {
    "name": "Basic Generation",
    "description": "Simple image generation workflow",
    "author": "Your Name",
    "version": "1.0.0",
    "tags": ["basic", "generation", "stable-diffusion"]
  },
  "nodes": {
    // Your ComfyUI workflow nodes here
  }
}
```

## ğŸ”§ Build System Integration

### Build Scripts

Update build scripts to handle your template:

```bash
# In scripts/build.sh, this is already handled by the case statement
# Your template will work automatically if you follow the naming convention
```

### Testing Integration

Add your template to testing:

```bash
# Add to scripts/test.sh (if you create one)
case $TARGET in
    "my-workflow")
        echo "ğŸ§ª Testing my-workflow template..."
        docker run --rm ghcr.io/nishit-g/aiclipse-my-workflow:rtx4090-latest /scripts/health-check.sh
        ;;
esac
```

## ğŸ“‹ Best Practices

### 1. **Naming Conventions**
- Template directory: `templates/my-workflow`
- Docker tags: `aiclipse-my-workflow:rtx4090-latest`
- Manifest files: `my_workflow_models.txt`

### 2. **Model Selection**
- Only include models you actually need
- Prefer smaller, efficient models when possible
- Document model purposes in comments

### 3. **Node Selection**
- Start with base nodes from `/manifests/base_nodes.txt`
- Add only template-specific nodes
- Test node compatibility

### 4. **Workflow Organization**
- Name workflows descriptively
- Include workflow metadata
- Provide example inputs

### 5. **Documentation**
- Create template README.md
- Document usage examples
- List requirements and recommendations

## ğŸš€ Deployment

### RunPod Template Creation

1. **Build and push your template**
2. **Create RunPod template** with:
   - Container Image: `ghcr.io/nishit-g/aiclipse-my-workflow:rtx4090-latest`
   - Exposed Ports: `22, 8188, 8080, 8888, 8048`
   - Volume Mount: `/workspace`

### Environment Variables for RunPod

```bash
TEMPLATE_TYPE=my-workflow
DOWNLOAD_MODELS=true
PUBLIC_KEY=your-ssh-public-key
HF_TOKEN=your-huggingface-token
```

## ğŸ” Troubleshooting

### Common Issues

**Build fails:**
```bash
# Check Dockerfile syntax
docker build -f templates/my-workflow/Dockerfile .

# Check dependencies
./scripts/configure.sh
```

**Models not downloading:**
```bash
# Check manifest format
# Verify HuggingFace token
# Check logs: /workspace/aiclipse/logs/models.log
```

**Nodes not loading:**
```bash
# Check node manifest format
# Verify repository URLs
# Check ComfyUI logs for import errors
```

## ğŸ“ Getting Help

- **GitHub Issues**: [Report problems](https://github.com/nishit-g/aiclipse-comfyui/issues)
- **Documentation**: Check existing templates for examples
- **Community**: Join our Discord for template development help

---

**Happy template building!** ğŸ‰
